<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>ãŸã¨ãˆã¦é™æ°´ç¢ºç‡</title>
  <style>
    body { font-family: -apple-system, system-ui; margin: 0; padding: 20px; }
    .card { border: 1px solid #ddd; border-radius: 16px; padding: 16px; margin: 12px 0; }
    .big { font-size: 40px; font-weight: 700; }
    .small { color: #666; font-size: 13px; }
    button { padding: 12px 14px; border-radius: 12px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    input, select { padding: 12px 14px; border-radius: 12px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
    label { margin-right: 12px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; }
    .muted { color:#888; font-size:12px; }
    .ok { color:#0a7; font-size:12px; }
    .ng { color:#c33; font-size:12px; }
    .pill { display:inline-block; padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; font-size:12px; margin-right: 6px; }
    .slot { border: 1px solid #eee; border-radius: 14px; padding: 12px; margin-top: 10px; }
    .slot .big { font-size: 34px; }
    .slot .small { margin-top: 6px; }

    /* ä¾‹ãˆæ–‡ï¼ˆæœãƒ»æ˜¼ãƒ»å¤œï¼‰ã‚’èª­ã¿ã‚„ã™ã */
    #meta_m, #meta_d, #meta_e {
      font-size: 18px;
      color: #333;
      line-height: 1.6;
      font-weight: 500;
    }

    /* äººé–“å‘ã‘ç¿»è¨³ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ã‚’å¤§ããï¼ˆPCå‘ã‘ï¼‰ */
    #metaphor {
      font-size: 26px;
      line-height: 1.7;
    }

    /* =========================
       ã‚¹ãƒãƒ›å¯¾å¿œï¼ˆç”»é¢å¹… 600px ä»¥ä¸‹ï¼‰
       ========================= */
    @media (max-width: 600px) {

      body { padding: 12px; }

      h1 {
        font-size: 22px;
        margin: 0 0 12px;
      }

      .card {
        padding: 12px;
        margin: 10px 0;
      }

      /* å…¥åŠ›æ¬„ãƒ»ãƒœã‚¿ãƒ³ã‚’æŒ‡ã§æŠ¼ã—ã‚„ã™ã */
      input, select, button {
        font-size: 16px;
        padding: 10px 12px;
      }

      .row {
        grid-template-columns: 1fr;
      }

      button#search {
        width: 100%;
      }

      /* %ï¼ˆæœãƒ»æ˜¼ãƒ»å¤œï¼‰ */
      .slot .big { font-size: 28px; }

      /* æœãƒ»æ˜¼ãƒ»å¤œã®ä¾‹ãˆæ–‡ */
      #meta_m, #meta_d, #meta_e {
        font-size: 15px;
        line-height: 1.55;
      }

      /* äººé–“å‘ã‘ç¿»è¨³ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ */
      #metaphor {
        font-size: 20px;
        line-height: 1.6;
      }

      /* ãƒ”ãƒ«ï¼ˆAPI / TZ è¡¨ç¤ºï¼‰ */
      .pill {
        font-size: 11px;
        padding: 5px 8px;
      }
    }
  </style>
</head>
<body>
  <h1>ãŸã¨ãˆã¦é™æ°´ç¢ºç‡</h1>

  <div class="card">
    <div class="small">å¤©æ°—äºˆå ±ã‚’çŸ¥ã‚ŠãŸã„åœ°ç‚¹</div>
    <div class="row" style="margin-top:8px;">
      <input id="place" placeholder="ä¾‹ï¼šä»™å°å¸‚ / Sendai / ä»™å°é§… / ä»™å°å¸‚é’è‘‰åŒº" />
      <button id="search">æ¤œç´¢</button>
    </div>
    <div style="margin-top:10px;">
      <select id="candidates" disabled>
        <option>æ¤œç´¢çµæœãŒã“ã“ã«å‡ºã¾ã™</option>
      </select>
      <div id="placeStatus" class="muted" style="margin-top:8px;">åœ°ç‚¹ã‚’å…¥åŠ›ã—ã¦ã€Œæ¤œç´¢ã€ã—ã¦ãã ã•ã„ï¼ˆAPIã‚­ãƒ¼ä¸è¦ï¼‰</div>
    </div>
  </div>

  <div class="card">
    <div class="small">ä¾‹ãˆãƒ¢ãƒ¼ãƒ‰</div>
    <div style="margin-top:8px;">
      <label><input type="radio" name="mode" value="serious" checked> çœŸé¢ç›®</label>
      <label><input type="radio" name="mode" value="trivia"> é›‘å­¦</label>
      <label><input type="radio" name="mode" value="fun"> ãŠç¬‘ã„</label>
    </div>
    <div class="muted" style="margin-top:8px;">â€»åŒã˜ç¢ºç‡ã§ã‚‚ã€æ¯å›ã¡ãŒã†ä¾‹ãˆãŒå‡ºã¾ã™</div>
  </div>

  <div class="card">
    <div class="small">ä»Šæ—¥ã®é™æ°´ç¢ºç‡ï¼ˆæœ/æ˜¼/å¤œï¼‰</div>
    <div class="small" id="popHint">åœ°ç‚¹ã‚’é¸ã¶ã¨è‡ªå‹•å–å¾—ã—ã¾ã™</div>

    <div class="slot">
      <div class="small">æœï¼ˆ6â€“11æ™‚ï¼‰</div>
      <div class="big" id="pop_m">--%</div>
      <div class="small" id="meta_m"></div>
    </div>

    <div class="slot">
      <div class="small">æ˜¼ï¼ˆ12â€“17æ™‚ï¼‰</div>
      <div class="big" id="pop_d">--%</div>
      <div class="small" id="meta_d"></div>
    </div>

    <div class="slot">
      <div class="small">å¤œï¼ˆ18â€“23æ™‚ï¼‰</div>
      <div class="big" id="pop_e">--%</div>
      <div class="small" id="meta_e"></div>
    </div>

    <div style="margin-top:10px;">
      <span class="pill" id="sourceTag">API: æœªæ¥ç¶š</span>
      <span class="pill" id="tzTag">TZ: --</span>
    </div>
  </div>

  <div class="card">
    <div class="small">äººé–“å‘ã‘ç¿»è¨³ï¼ˆæ¯å›ãƒ©ãƒ³ãƒ€ãƒ ï¼‰</div>
    <div class="big" id="metaphor">åœ°ç‚¹ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="muted" id="metaFoot" style="margin-top:10px;"></div>
  </div>

  <button id="refresh">åŒã˜ç¢ºç‡ã§ã‚‚ä¾‹ãˆã‚’å¤‰ãˆã‚‹</button>

  <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ã¨ãƒã‚¿è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="card" id="likeSection">
    <div class="small">ã“ã®ãƒã‚¿ã‚’è©•ä¾¡</div>
    <div style="margin-top:8px;">
      <button id="likeBtn">ğŸ‘ã„ã„ã­ (<span id="likeCount">0</span>)</button>
      <span id="specialBadge" style="margin-left:10px;font-size:20px;"></span>
    </div>
  </div>

  <div class="card" id="addSection">
    <div class="small">ãƒã‚¿ã‚’è¿½åŠ </div>
    <div style="margin-top:8px;">
      <textarea id="newPhrase" rows="3" placeholder="ä¾‹ï¼šé™ã£ãŸã‚‰ä¼šç¤¾ã®ã›ã„"></textarea>
    </div>
    <div style="margin-top:8px;">
      <select id="newPhraseMode">
        <option value="serious">çœŸé¢ç›®</option>
        <option value="trivia">é›‘å­¦</option>
        <option value="fun">ãŠç¬‘ã„</option>
      </select>
      <button id="addPhraseBtn" style="margin-left:10px;">è¿½åŠ </button>
    </div>
    <div class="muted" id="addStatus" style="margin-top:8px;"></div>
  </div>

  <!-- å¤–éƒ¨ã®ä¾‹ãˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ -->
  <script src="metaphors.js"></script>

  <script>

    // =========================
    // å¤©æ°—å–å¾—ï¼šOpen-Meteo
    // =========================
    const GEO = "https://geocoding-api.open-meteo.com/v1/search";
    const FC  = "https://api.open-meteo.com/v1/forecast";

    let state = {
      pops: null,         // { m: number|null, d: number|null, e: number|null }
      placeLabel: null,
      tz: null,
      source: "API: æœªæ¥ç¶š",
    };
    // å‰å›é¸ã‚“ã ä¾‹ãˆæ–‡ã‚’è¨˜æ†¶ã—ã¦ãŠãã€é€£ç¶šåŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºãªã„ã‚ˆã†ã«ã™ã‚‹
    const lastMetaphor = {};
    // randomFact ã¯ metaphors.js ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™

    /* ã„ã„ã­æ©Ÿèƒ½ãƒ»ãƒã‚¿è¿½åŠ æ©Ÿèƒ½ç”¨ã®å®šæ•°ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° */
    const LIKES_KEY = "metaphorLikes";
    const ADDED_KEY = "addedPhrases";

    // ã„ã„ã­ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadLikes() {
      try {
        return JSON.parse(localStorage.getItem(LIKES_KEY) || '{}');
      } catch (e) {
        return {};
      }
    }
    function saveLikes(obj) {
      localStorage.setItem(LIKES_KEY, JSON.stringify(obj));
    }
    let likesData = loadLikes();
    function getLikesFor(phrase) {
      return likesData[phrase] || 0;
    }
    function incrementLike(phrase) {
      likesData[phrase] = (likesData[phrase] || 0) + 1;
      saveLikes(likesData);
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¿½åŠ ã—ãŸãƒã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadAddedPhrases() {
      try {
        return JSON.parse(localStorage.getItem(ADDED_KEY) || '{}');
      } catch (e) {
        return {};
      }
    }
    function saveAddedPhrases(obj) {
      localStorage.setItem(ADDED_KEY, JSON.stringify(obj));
    }
    let addedPhrases = loadAddedPhrases();

    // é‡ã¿ä»˜ã‘ã•ã‚ŒãŸãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼šã„ã„ã­æ•°ãŒå¤šã„ã»ã©é¸ã°ã‚Œã‚„ã™ãã™ã‚‹
    function pickWeightedRandom(arr) {
      const weights = arr.map(item => {
        if (typeof item === 'function') return 1;
        const text = item;
        return (likesData[text] || 0) + 1;
      });
      const total = weights.reduce((a,b) => a + b, 0);
      let r = Math.random() * total;
      for (let i = 0; i < arr.length; i++) {
        if (r < weights[i]) return arr[i];
        r -= weights[i];
      }
      return arr[0];
    }

    // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹è¿½åŠ ãƒã‚¿ã‚’metaphorDBã«æŒ¿å…¥ï¼ˆä¸­ç¨‹åº¦ã®ç¢ºç‡å¸¯ 30-49 ã«è¿½åŠ ï¼‰
    function applyAddedPhrases() {
      ['serious','trivia','fun'].forEach(mode => {
        const arr = addedPhrases[mode] || [];
        if (arr.length && metaphorDB[mode] && metaphorDB[mode][2]) {
          arr.forEach(p => {
            if (!metaphorDB[mode][2].texts.includes(p)) {
              metaphorDB[mode][2].texts.push(p);
            }
          });
        }
      });
    }

    // åˆæœŸåŒ–æ™‚ã«è¿½åŠ ãƒã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ 
    applyAddedPhrases();

    function pickRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getMode() {
      return document.querySelector('input[name="mode"]:checked').value;
    }

    function metaphorFor(pop, mode) {
      const ranges = metaphorDB[mode] || [];
      const r = ranges.find(x => pop >= x.min && pop <= x.max) || ranges[ranges.length - 1];
      // é‡ã¿ä»˜ã‘ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
      let picked = pickWeightedRandom(r.texts);
      // åŒã˜ãƒ¢ãƒ¼ãƒ‰ã¨ç¯„å›²ã§é€£ç¶šã—ã¦åŒã˜ãƒ†ã‚­ã‚¹ãƒˆãŒé¸ã°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
      if (r.texts && r.texts.length > 1) {
        const key = `${mode}:${r.min}-${r.max}`;
        let attempts = 0;
        while (picked === lastMetaphor[key] && attempts < 5) {
          picked = pickRandom(r.texts);
          attempts++;
        }
        lastMetaphor[key] = picked;
      }
      return (typeof picked === "function") ? picked() : picked;
    }

    function setStatus(text, kind="muted") {
      const el = document.getElementById("placeStatus");
      el.className = kind;
      el.textContent = text;
    }

    // â˜… æ—¥æœ¬èªåœ°åã‚’å°‘ã—ã§ã‚‚ãƒ’ãƒƒãƒˆã—ã‚„ã™ãã™ã‚‹å‰å‡¦ç†
    function normalizePlaceName(input) {
      return input
        .replace(/[ ã€€]+/g, " ")
        .replace(/(éƒ½|é“|åºœ|çœŒ|å¸‚|åŒº|ç”º|æ‘)$/g, "")   // æœ«å°¾ã®è¡Œæ”¿å˜ä½ã‚’è½ã¨ã™
        .replace(/(éƒ½|é“|åºœ|çœŒ|å¸‚|åŒº|ç”º|æ‘)/g, "")     // é€”ä¸­ã‚‚è»½ãè½ã¨ã™ï¼ˆä»™å°å¸‚é’è‘‰åŒº â†’ ä»™å°é’è‘‰ï¼‰
        .trim();
    }

    function render() {
      const hintEl = document.getElementById("popHint");
      const sourceTag = document.getElementById("sourceTag");
      const tzTag = document.getElementById("tzTag");

      const metaAll = document.getElementById("metaphor");
      const footEl = document.getElementById("metaFoot");

      sourceTag.textContent = state.source;
      tzTag.textContent = state.tz ? `TZ: ${state.tz}` : "TZ: --";

      const mode = getMode();

      const setSlot = (idPop, idMeta, value, label) => {
        const popEl = document.getElementById(idPop);
        const metaEl = document.getElementById(idMeta);

        if (value == null) {
          popEl.textContent = "--%";
          metaEl.textContent = "ãƒ‡ãƒ¼ã‚¿ãªã—";
          return null;
        }

        popEl.textContent = `${value}%`;
        const text = metaphorFor(value, mode);
        metaEl.textContent = `${label}ï¼š${text}`;
        return { value, text, label };
      };

      if (!state.pops) {
        hintEl.textContent = "åœ°ç‚¹ã‚’é¸ã¶ã¨è‡ªå‹•å–å¾—ã—ã¾ã™";
        setSlot("pop_m", "meta_m", null, "æœ");
        setSlot("pop_d", "meta_d", null, "æ˜¼");
        setSlot("pop_e", "meta_e", null, "å¤œ");
        metaAll.textContent = "åœ°ç‚¹ã‚’é¸ã‚“ã§ãã ã•ã„";
        footEl.textContent = "";
        // ã„ã„ã­UIã®ãƒªã‚»ãƒƒãƒˆ
        const likeCountEl = document.getElementById("likeCount");
        const likeBtn = document.getElementById("likeBtn");
        const badgeEl = document.getElementById("specialBadge");
        likeCountEl.textContent = "0";
        badgeEl.textContent = "";
        likeBtn.disabled = true;
        state.currentPhrase = null;
        return;
      }

      hintEl.textContent = state.placeLabel ? `åœ°ç‚¹ï¼š${state.placeLabel}` : "åœ°ç‚¹ï¼š--";

      const a = setSlot("pop_m", "meta_m", state.pops.m, "æœ");
      const b = setSlot("pop_d", "meta_d", state.pops.d, "æ˜¼");
      const c = setSlot("pop_e", "meta_e", state.pops.e, "å¤œ");

      const candidates = [a, b, c].filter(Boolean);
      const likeCountEl = document.getElementById("likeCount");
      const likeBtn = document.getElementById("likeBtn");
      const badgeEl = document.getElementById("specialBadge");
      if (!candidates.length) {
        metaAll.textContent = "ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆåˆ¥åœ°ç‚¹ã§è©¦ã—ã¦ãã ã•ã„ï¼‰";
        // ã„ã„ã­UIã‚’åˆæœŸåŒ–
        likeCountEl.textContent = "0";
        badgeEl.textContent = "";
        likeBtn.disabled = true;
        state.currentPhrase = null;
      } else {
        const maxOne = candidates.reduce((x, y) => (y.value > x.value ? y : x));
        metaAll.textContent = `ä»Šæ—¥ã„ã¡ã°ã‚“æ€ªã—ã„ã®ã¯ã€${maxOne.label}ã€‘ï¼š${maxOne.value}% â†’ ${maxOne.text}`;
        // ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ä¿å­˜
        state.currentPhrase = maxOne.text;
        // ã„ã„ã­ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¦UIæ›´æ–°
        const currentLikes = getLikesFor(state.currentPhrase);
        likeCountEl.textContent = String(currentLikes);
        badgeEl.textContent = currentLikes >= 5 ? "â­äººæ°—ï¼" : "";
        likeBtn.disabled = false;
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°
        likeBtn.onclick = () => {
          if (!state.currentPhrase) return;
          incrementLike(state.currentPhrase);
          const count = getLikesFor(state.currentPhrase);
          likeCountEl.textContent = String(count);
          badgeEl.textContent = count >= 5 ? "â­äººæ°—ï¼" : "";
        };
      }

      if (mode === "serious") {
        footEl.textContent = "â€»çœŸé¢ç›®ãƒ¢ãƒ¼ãƒ‰ï¼šçµ±è¨ˆãƒã‚¿ç­‰ã‚’æ··ãœãŸâ€œãŸã‚ã«ãªã‚‹ä¾‹ãˆâ€ã‚’ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º";
      } else if (mode === "trivia" || mode === "normal") {
        footEl.textContent = "â€»é›‘å­¦ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¥å¸¸ä¼šè©±ã®æ¸©åº¦æ„Ÿã§ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º";
      } else {
        footEl.textContent = "â€»ãŠç¬‘ã„ãƒ¢ãƒ¼ãƒ‰ï¼šSNSå‘ã‘ã«éŠã‚“ã ä¾‹ãˆã‚’ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º";
      }
    }

    async function geocode(name) {
      const url = new URL(GEO);
      url.searchParams.set("name", name);
      url.searchParams.set("count", "10");
      url.searchParams.set("language", "ja");
      url.searchParams.set("format", "json");
      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error("åœ°ç‚¹æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ");
      return await res.json();
    }

    async function fetchPopsBySlots(lat, lon) {
      const url = new URL(FC);
      url.searchParams.set("latitude", String(lat));
      url.searchParams.set("longitude", String(lon));
      url.searchParams.set("hourly", "precipitation_probability");
      url.searchParams.set("timezone", "auto");
      url.searchParams.set("forecast_days", "2");

      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error("å¤©æ°—å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      const data = await res.json();

      const times = data.hourly?.time || [];
      const pops  = data.hourly?.precipitation_probability || [];
      const tz    = data.timezone || null;

      const today = (times[0] || "").slice(0, 10);
      const bucket = { m: [], d: [], e: [] };

      for (let i = 0; i < Math.min(times.length, pops.length); i++) {
        const t = times[i];
        const p = pops[i];
        if (typeof p !== "number") continue;
        if (!t || t.slice(0, 10) !== today) continue;

        const hour = Number(t.slice(11, 13));
        if (hour >= 6 && hour <= 11) bucket.m.push(p);
        else if (hour >= 12 && hour <= 17) bucket.d.push(p);
        else if (hour >= 18 && hour <= 23) bucket.e.push(p);
      }

      const maxOrNull = (arr) => arr.length ? Math.round(Math.max(...arr)) : null;

      return {
        pops: {
          m: maxOrNull(bucket.m),
          d: maxOrNull(bucket.d),
          e: maxOrNull(bucket.e),
        },
        tz
      };
    }

    // UI: æ¤œç´¢â†’å€™è£œè¡¨ç¤º
    document.getElementById("search").onclick = async () => {
      const raw = document.getElementById("place").value.trim();
      const q = normalizePlaceName(raw);

      const sel = document.getElementById("candidates");
      sel.innerHTML = "";
      sel.disabled = true;

      if (!q) {
        setStatus("åœ°ç‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "ng");
        return;
      }

      setStatus("æ¤œç´¢ä¸­â€¦", "muted");

      try {
        // ã¾ãšæ­£è¦åŒ–ã—ãŸæ–‡å­—åˆ—ã§æ¤œç´¢
        let g = await geocode(q);
        let results = g.results || [];

        // ã‚‚ã—ãƒ€ãƒ¡ãªã‚‰ã€ç”Ÿå…¥åŠ›ã§ã‚‚ä¸€åº¦è©¦ã™ï¼ˆä¿é™ºï¼‰
        if (!results.length && raw !== q) {
          g = await geocode(raw);
          results = g.results || [];
        }

        if (!results.length) {
          setStatus("å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®æ›¸ãæ–¹ã§è©¦ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šSendaiï¼‰", "ng");
          return;
        }

        results.forEach((r, idx) => {
          const labelParts = [r.name, r.admin1, r.country].filter(Boolean);
          const label = labelParts.join(" / ");
          const opt = document.createElement("option");
          opt.value = String(idx);
          opt.textContent = label;
          opt.dataset.lat = r.latitude;
          opt.dataset.lon = r.longitude;
          sel.appendChild(opt);
        });

        sel.disabled = false;
        setStatus("å€™è£œã‚’é¸ã¶ã¨å¤©æ°—ã‚’å–å¾—ã—ã¾ã™", "ok");

        sel.onchange = async () => {
          const opt = sel.options[sel.selectedIndex];
          const lat = Number(opt.dataset.lat);
          const lon = Number(opt.dataset.lon);

          state.placeLabel = opt.textContent;
          state.source = "API: Open-Meteo";
          render();
          setStatus("å¤©æ°—å–å¾—ä¸­â€¦", "muted");

          try {
            const out = await fetchPopsBySlots(lat, lon);
            state.pops = out.pops;
            state.tz = out.tz;

            const any = (state.pops.m != null) || (state.pops.d != null) || (state.pops.e != null);
            if (!any) {
              setStatus("é™æ°´ç¢ºç‡ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆåˆ¥åœ°ç‚¹ã§è©¦ã—ã¦ãã ã•ã„ï¼‰", "ng");
              state.source = "API: å–å¾—å¤±æ•—";
              state.pops = null;
            } else {
              setStatus("å–å¾—ã—ã¾ã—ãŸ", "ok");
            }

            render();
          } catch (e) {
            setStatus(e.message || "å¤©æ°—å–å¾—ã‚¨ãƒ©ãƒ¼", "ng");
            state.source = "API: ã‚¨ãƒ©ãƒ¼";
            state.pops = null;
            render();
          }
        };

        // è‡ªå‹•ã§1ä»¶ç›®ã‚’é¸æŠã—ã¦å³å–å¾—
        sel.selectedIndex = 0;
        sel.onchange();

      } catch (e) {
        setStatus(e.message || "æ¤œç´¢ã‚¨ãƒ©ãƒ¼", "ng");
      }
    };

    // ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã§ä¾‹ãˆæ›´æ–°ï¼ˆåŒã˜ç¢ºç‡ã§ã‚‚ãƒ©ãƒ³ãƒ€ãƒ ãŒå¤‰ã‚ã‚‹ï¼‰
    document.querySelectorAll('input[name="mode"]').forEach(r =>
      r.addEventListener("change", render)
    );

    // ã€ŒåŒã˜ç¢ºç‡ã§ã‚‚ä¾‹ãˆã‚’å¤‰ãˆã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆç¢ºç‡ã¯ãã®ã¾ã¾ã€æ–‡ç« ã ã‘ãƒ©ãƒ³ãƒ€ãƒ æ›´æ–°ï¼‰
    document.getElementById("refresh").onclick = () => render();

    // è¿½åŠ ãƒã‚¿ãƒœã‚¿ãƒ³
    document.getElementById("addPhraseBtn").onclick = () => {
      const textarea = document.getElementById("newPhrase");
      const modeSel  = document.getElementById("newPhraseMode");
      const statusEl = document.getElementById("addStatus");
      const text = textarea.value.trim();
      const mode = modeSel.value;
      if (!text) {
        statusEl.textContent = "å…¥åŠ›ãŒç©ºã§ã™";
        return;
      }
      // ä¸­ç¨‹åº¦ã®ç¢ºç‡å¸¯ (index 2) ã«è¿½åŠ 
      if (metaphorDB[mode] && metaphorDB[mode][2]) {
        if (!metaphorDB[mode][2].texts.includes(text)) {
          metaphorDB[mode][2].texts.push(text);
        }
        addedPhrases[mode] = addedPhrases[mode] || [];
        if (!addedPhrases[mode].includes(text)) {
          addedPhrases[mode].push(text);
          saveAddedPhrases(addedPhrases);
        }
        statusEl.textContent = "è¿½åŠ ã—ã¾ã—ãŸï¼";
        textarea.value = "";
      } else {
        statusEl.textContent = "è¿½åŠ ã§ãã¾ã›ã‚“ã§ã—ãŸ";
      }
    };

    // Service Workerç™»éŒ²ï¼ˆPWAï¼‰
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js", { scope: "./" });
    }

    render();
  </script>
</body>
</html>
