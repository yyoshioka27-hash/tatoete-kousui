// ==============================
// 追加ネタ管理（localStorage）
// 既存機能は触らず、管理UIだけ増やす
// ==============================
(() => {
  const LS_KEY = "extra_phrases_v1";

  // ----- utils -----
  const $ = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function loadStore() {
    // 形式： [{id, mode, bucket, text, createdAt}, ...]
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return [];
      const data = JSON.parse(raw);
      return Array.isArray(data) ? data : [];
    } catch {
      return [];
    }
  }

  function saveStore(list) {
    localStorage.setItem(LS_KEY, JSON.stringify(list));
  }

  function getMode() {
    const el = $("manageMode");
    return el ? el.value : "trivia";
  }

  function getBucket() {
    const el = $("manageBucket");
    return el ? Number(el.value) : 0;
  }

  function setStatus(msg, cls = "muted") {
    const el = $("manageStatus");
    if (!el) return;
    el.className = cls;
    el.textContent = msg;
  }

  // ----- render list -----
  function renderManageList() {
    const listEl = $("manageList");
    if (!listEl) return;

    const mode = getMode();
    const bucket = getBucket();
    const store = loadStore();

    const filtered = store
      .filter((x) => x.mode === mode && Number(x.bucket) === bucket)
      .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

    if (filtered.length === 0) {
      listEl.innerHTML = `<div class="muted">この条件の追加ネタはありません。</div>`;
      setStatus(`表示：0件（モード=${mode}, 確率=${bucket}%）`, "muted");
      return;
    }

    setStatus(`表示：${filtered.length}件（モード=${mode}, 確率=${bucket}%）`, "ok");

    listEl.innerHTML = `
      <div style="display:grid; gap:8px;">
        ${filtered
          .map(
            (item) => `
          <div style="border:1px solid #eee; border-radius:14px; padding:12px;">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <div style="flex:1;">
                <div class="small">
                  <b>${escapeHtml(item.bucket)}%</b> / ${escapeHtml(item.mode)}
                  <span class="muted" style="margin-left:8px;">
                    ${item.createdAt ? new Date(item.createdAt).toLocaleString() : ""}
                  </span>
                </div>
                <div style="margin-top:6px; white-space:pre-wrap; font-size:16px; line-height:1.5;">
                  ${escapeHtml(item.text)}
                </div>
              </div>
              <button data-del-id="${escapeHtml(item.id)}">削除</button>
            </div>
          </div>
        `
          )
          .join("")}
      </div>
    `;

    // 削除ボタン
    listEl.querySelectorAll("button[data-del-id]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del-id");
        deleteOne(id);
      });
    });
  }

  function deleteOne(id) {
    const store = loadStore();
    const next = store.filter((x) => x.id !== id);
    saveStore(next);
    renderManageList();
  }

  function clearBucket() {
    const mode = getMode();
    const bucket = getBucket();
    const store = loadStore();
    const next = store.filter((x) => !(x.mode === mode && Number(x.bucket) === bucket));
    saveStore(next);
    renderManageList();
  }

  function clearAll() {
    saveStore([]);
    renderManageList();
  }

  // ----- add phrase -----
  function addPhraseFromUI() {
    const modeEl = $("newPhraseMode");
    const bucketEl = $("newPhraseBucket");
    const textEl = $("newPhrase");
    const statusEl = $("addStatus");

    if (!modeEl || !bucketEl || !textEl) return;

    const mode = modeEl.value;
    const bucket = Number(bucketEl.value);
    const text = (textEl.value || "").trim();

    if (!text) {
      if (statusEl) statusEl.textContent = "未入力です。ネタ文を入れてください。";
      return;
    }

    const store = loadStore();
    const item = {
      id: (globalThis.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
      mode,
      bucket,
      text,
      createdAt: Date.now(),
    };
    store.push(item);
    saveStore(store);

    // 入力欄クリア
    textEl.value = "";
    if (statusEl) statusEl.textContent = `保存しました（${mode} / ${bucket}%）`;

    // 管理側の条件と一致してたら即反映
    renderManageList();
  }

  // ----- bind events on load -----
  document.addEventListener("DOMContentLoaded", () => {
    // 管理UIが無いページでも落ちないようにガード
    if ($("manageRefresh")) $("manageRefresh").addEventListener("click", renderManageList);
    if ($("manageMode")) $("manageMode").addEventListener("change", renderManageList);
    if ($("manageBucket")) $("manageBucket").addEventListener("change", renderManageList);

    if ($("manageClearBucket")) $("manageClearBucket").addEventListener("click", () => {
      if (confirm("この%の追加ネタを全削除します。よろしいですか？")) clearBucket();
    });

    if ($("manageClearAll")) $("manageClearAll").addEventListener("click", () => {
      if (confirm("全ての追加ネタを削除します。よろしいですか？")) clearAll();
    });

    if ($("addPhraseBtn")) $("addPhraseBtn").addEventListener("click", addPhraseFromUI);

    // 初回表示
    renderManageList();
  });

  // ★ もし「例え表示側」で追加ネタを使いたい場合は、ここを他のコードから呼べます
  // window.getExtraPhrases = (mode, bucket) => loadStore().filter(x => x.mode===mode && Number(x.bucket)===Number(bucket)).map(x => x.text);

})();
