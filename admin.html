<!-- admin.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <title>管理（承認待ち／一般公開）</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --sub:#64748b;
      --line:rgba(15,23,42,.12);
      --card:#ffffff;
      --shadow:0 10px 24px rgba(2,6,23,.08);
      --blue:#2563eb;
      --red:#ef4444;
      --green:#16a34a;
      --btn:#0f172a;
      --btnText:#fff;
      --mutedBg:rgba(15,23,42,.04);
      --radius:16px;
    }
    body{ margin:0; padding:18px; font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
    .container{ max-width:980px; margin:0 auto; }
    h1{ margin:6px 0 16px; font-size:24px; letter-spacing:-.2px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin:12px 0; }
    .muted{ color:var(--sub); font-size:12px; }
    label{ font-size:12px; color:var(--sub); display:block; margin-bottom:6px; }
    input, select{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); min-width:280px; font-size:14px; background:#fff; outline:none; }
    input:focus, select:focus{ border-color: rgba(37,99,235,0.55); box-shadow: 0 0 0 4px rgba(37,99,235,0.12); }
    button{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer; font-size:14px; user-select:none; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .btnPrimary{ background:var(--blue); color:#fff; border-color:rgba(37,99,235,0.55); font-weight:800; }
    .btnDanger{ background:var(--red); color:#fff; border-color:rgba(239,68,68,.6); font-weight:800; }
    .btnOk{ background:var(--green); color:#fff; border-color: rgba(22,163,74,.6); font-weight:800; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--mutedBg); font-size:12px; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tab{ padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; font-weight:800; }
    .tab.active{ background:var(--btn); color:var(--btnText); border-color:rgba(15,23,42,.35); }
    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; padding:10px 0 0; border-top:1px solid rgba(15,23,42,.08); margin-top:10px; }
    .list{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .item{ border:1px solid rgba(15,23,42,.10); border-radius:14px; padding:12px; background:rgba(255,255,255,.9); }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .itemText{ font-size:15px; line-height:1.55; font-weight:700; margin:8px 0; white-space:pre-wrap; }
    .itemMeta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid rgba(15,23,42,.12); background:rgba(255,255,255,.75); font-size:12px; color:var(--sub); font-weight:800; }
    .badgePublic{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.07); color: #166534; }
    .badgePending{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.07); color: #991b1b; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chk{ transform:translateY(1px); }
    .right{ margin-left:auto; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .smallBtn{ padding:8px 10px; border-radius:10px; font-size:13px; }
    details > summary{ cursor:pointer; user-select:none; color:var(--sub); font-size:12px; }
  </style>

  <!-- ✅ 元ネタ（metaphors.js）を先に読み込む -->
  <script src="./metaphors.js"></script>
</head>

<body>
<div class="container">
  <h1>管理（承認待ち／一般公開）</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>API_BASE</label>
        <input id="apiBase" class="mono" />
      </div>
      <div>
        <label>ADMIN_KEY</label>
        <input id="adminKey" class="mono" placeholder="例：2355" />
      </div>

      <div class="row" style="gap:8px; align-items:flex-end;">
        <button id="btnSave" class="btnPrimary">保存</button>
        <button id="btnHealth">health</button>
        <button id="btnRefresh">更新（表示中タブ）</button>
        <button id="btnRefreshAllTabs">更新（全タブ）</button>
        <button id="btnImportSeed">初期ネタを取り込み</button>
      </div>

      <div class="right row" style="gap:8px;">
        <span class="pill" id="pillHealth">health: 未確認</span>
        <span class="pill" id="pillAdmin">admin: 未確認</span>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ※ 管理操作は <span class="mono">x-admin-key</span> ヘッダで送ります。<span class="mono">ADMIN_KEY</span> が間違うと 403 になります。<br/>
      ※ 却下は「却下→削除（pendingから消す）」まで自動で行います。
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="tabs">
        <button id="tabPending" class="tab active">承認待ち</button>
        <button id="tabPublic" class="tab">一般公開</button>
        <button id="tabAll" class="tab">全ネタ（public+pending+元ネタ）</button>
      </div>
      <div class="muted" id="counts">承認待ち: 0件 / 公開: 0件 / 全: 0件</div>
    </div>

    <div class="toolbar">
      <div class="row" style="gap:12px;">
        <label style="margin:0; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="chkAll" class="chk" />
          全選択
        </label>
        <span class="pill" id="selCount">選択: 0件</span>
        <span class="pill" id="pillBusy" style="display:none;">通信中…</span>
      </div>
      <div class="actions">
        <button id="btnBulkApprove" class="btnOk">一括承認</button>
        <button id="btnBulkReject" class="btnDanger">一括却下（→削除）</button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ※ 承認待ち: <span class="mono">/api/admin/pending</span> / 承認: <span class="mono">/api/admin/approve</span> / 却下: <span class="mono">/api/admin/reject</span> / 削除: <span class="mono">/api/admin/delete</span><br/>
      ※ 公開: <span class="mono">/api/admin/list</span><br/>
      ※ 全ネタ: <span class="mono">/api/admin/all?scope=both</span> ＋（metaphors.js元ネタは表示のみ）
    </div>

    <div class="list" id="list"></div>
  </div>

  <div class="muted" style="text-align:center; margin:14px 0 8px;">
    admin.html（統合・堅牢版） / # END
  </div>
</div>

<script>
(() => {
  const DEFAULT_API_BASE = "https://ancient-union-4aa4tatoete-kousui-api.y-yoshioka27.workers.dev";
  const LS_API = "tatoete_admin_api_base";
  const LS_KEY = "tatoete_admin_key";

  const $ = (id) => document.getElementById(id);

  const elApiBase = $("apiBase");
  const elAdminKey = $("adminKey");
  const pillHealth = $("pillHealth");
  const pillAdmin  = $("pillAdmin");
  const countsEl   = $("counts");
  const listEl     = $("list");

  const tabPending = $("tabPending");
  const tabPublic  = $("tabPublic");
  const tabAll     = $("tabAll");

  const chkAll     = $("chkAll");
  const selCount   = $("selCount");
  const pillBusy   = $("pillBusy");

  const btnSave    = $("btnSave");
  const btnHealth  = $("btnHealth");
  const btnRefresh = $("btnRefresh");
  const btnRefreshAllTabs = $("btnRefreshAllTabs");
  const btnImportSeed = $("btnImportSeed");

  const btnBulkApprove = $("btnBulkApprove");
  const btnBulkReject  = $("btnBulkReject");

  let activeTab = "pending"; // pending | public | all
  let itemsPending = [];
  let itemsPublic  = [];
  let itemsAll     = [];
  let selectedIds = new Set();
  let itemsSeedLocal = [];

  // in-flight制御
  let __busy = false;
  let __ctrl = null;

  function getSignal(){
    return __ctrl ? __ctrl.signal : undefined;
  }

  function apiBase(){
    return String(elApiBase.value || "").trim().replace(/\/+$/,"");
  }
  function adminKey(){
    return String(elAdminKey.value || "").trim();
  }

  function setPill(el, text, ok=null){
    el.textContent = text;
    el.style.borderColor = ok===true ? "rgba(22,163,74,.45)"
                      : ok===false ? "rgba(239,68,68,.45)"
                      : "rgba(15,23,42,.20)";
  }

  function setBusy(on){
    __busy = !!on;
    pillBusy.style.display = __busy ? "inline-flex" : "none";
    const dis = __busy;
    [btnSave, btnHealth, btnRefresh, btnRefreshAllTabs, btnImportSeed,
     tabPending, tabPublic, tabAll,
     btnBulkApprove, btnBulkReject].forEach(b => { try{ b.disabled = dis; }catch{} });
  }

  function abortInFlight(){
    try{ if (__ctrl) __ctrl.abort(); }catch{}
    __ctrl = null;
    setBusy(false);
  }

  async function fetchJSON(path, { method="GET", body=null, admin=false, signal=undefined } = {}){
    const base = apiBase();
    if (!base) throw new Error("API_BASE が空です");

    const url = base + path;
    const headers = { "Content-Type":"application/json" };
    if (admin){
      const k = adminKey();
      if (!k) throw new Error("ADMIN_KEY が空です");
      headers["x-admin-key"] = k;
    }

    const res = await fetch(url, {
      method,
      headers,
      body: body ? JSON.stringify(body) : null,
      signal
    });

    const data = await res.json().catch(()=>null);

    if (!res.ok || !data?.ok){
      const msg = data?.error || `HTTP ${res.status}`;
      const e = new Error(msg);
      e.status = res.status;
      e.data = data;
      throw e;
    }
    return data;
  }

  // ✅ 404のとき別名APIを順番に試す（あなたの環境でapproveが404になっていたため）
  async function postWithFallback(paths, body, {admin=true} = {}){
    let lastErr = null;
    for (const p of paths){
      try{
        const data = await fetchJSON(p, { method:"POST", admin, body, signal:getSignal() });
        return { ok:true, path:p, data };
      }catch(e){
        lastErr = e;
        // 404は次を試す。それ以外は即終了
        if (e?.status !== 404) throw e;
      }
    }
    // 全滅
    if (lastErr) throw lastErr;
    throw new Error("API呼び出しに失敗しました");
  }

  function formatTs(ts){
    const n = Number(ts);
    if (!Number.isFinite(n) || n <= 0) return "";
    const d = new Date(n);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  function safeText(v){ return (v == null) ? "" : String(v); }

  function normalizeScope(x, fallback){
    const s = (x?.scope ?? x?._scope ?? x?.status ?? fallback ?? "").toString().toLowerCase().trim();
    if (s === "public" || s === "pending") return s;
    return fallback || "";
  }

  function normalizeItems(arr, fallbackScope){
    return (Array.isArray(arr) ? arr : []).map(x => {
      const scope = normalizeScope(x, fallbackScope || "");
      return {
        id: safeText(x.id ?? x.key ?? x._id ?? ""),
        text: safeText(x.text ?? x.metaphor ?? x.value ?? ""),
        bucket: (x.bucket ?? x.b ?? null),
        mode: safeText(x.mode ?? x.m ?? ""),
        likes: (x.likes ?? x.like ?? x.totalLikes ?? 0),
        penName: safeText(x.penName ?? x.pen ?? x.author ?? ""),
        createdAt: (x.createdAt ?? x.ts ?? x.time ?? x.approvedAt ?? 0),
        scope
      };
    }).filter(x => x.id);
  }

  // -------------------------
  // 元ネタ（metaphors.js）表示用
  // -------------------------
  function hash32(str){
    let h = 2166136261;
    for (let i = 0; i < str.length; i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0).toString(16);
  }

  function loadSeedLocalFromMetaphorsJS(){
    const trivia = window.NETA_TRIVIA; // {0:[...],10:[...],...}
    const fun    = window.NETA;        // {0:[...],10:[...],...}
    const out = [];

    function pushFromDict(dict, modeLabel){
      if (!dict || typeof dict !== "object") return;
      for (const k of Object.keys(dict)){
        const bucket = Number(k);
        if (!Number.isFinite(bucket)) continue;
        const arr = dict[k];
        if (!Array.isArray(arr)) continue;
        for (const t of arr){
          const text = String(t ?? "").trim();
          if (!text) continue;
          out.push({ mode: modeLabel, bucket, text });
        }
      }
    }

    pushFromDict(trivia, "trivia");
    pushFromDict(fun, "fun");

    // 保険：metaphorDB形式
    if (!out.length && window.metaphorDB){
      try{
        const dbT = window.metaphorDB.trivia;
        const dbF = window.metaphorDB.fun;
        function pushFromDB(db, modeLabel){
          if (!Array.isArray(db)) return;
          for (const row of db){
            const bucket = Number(row?.min);
            const texts = row?.texts;
            if (!Number.isFinite(bucket) || !Array.isArray(texts)) continue;
            for (const t of texts){
              const text = String(t ?? "").trim();
              if (!text) continue;
              out.push({ mode: modeLabel, bucket, text });
            }
          }
        }
        pushFromDB(dbT, "trivia");
        pushFromDB(dbF, "fun");
      } catch {}
    }

    itemsSeedLocal = out.map(x => ({
      id: "seedjs_" + hash32(`${x.mode}|${x.bucket}|${x.text}`),
      text: x.text,
      bucket: x.bucket,
      mode: x.mode,
      likes: 0,
      penName: "元ネタ(metaphors.js)",
      createdAt: 0,
      scope: "seed-local"
    }));
  }

  // -------------------------
  // 表示
  // -------------------------
  function updateCounts(){
    countsEl.textContent = `承認待ち: ${itemsPending.length}件 / 公開: ${itemsPublic.length}件 / 全: ${itemsAll.length}件`;
  }

  function updateSelectionUI(){
    selCount.textContent = `選択: ${selectedIds.size}件`;
    const current = getActiveItems();
    const allIds = current.map(x => x.id);
    const allSelected = allIds.length > 0 && allIds.every(id => selectedIds.has(id));
    chkAll.checked = allSelected;
    chkAll.indeterminate = (!allSelected && selectedIds.size > 0);
  }

  function setActiveTab(tab){
    activeTab = tab;
    tabPending.classList.toggle("active", tab==="pending");
    tabPublic.classList.toggle("active",  tab==="public");
    tabAll.classList.toggle("active",     tab==="all");
    selectedIds = new Set();
    render();
  }

  function getActiveItems(){
    if (activeTab === "pending") return itemsPending;
    if (activeTab === "public")  return itemsPublic;
    return itemsAll;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll("`","&#096;");
  }

  function render(){
    updateCounts();
    const items = getActiveItems();
    updateSelectionUI();

    if (!items.length){
      listEl.innerHTML = `<div class="muted">（データがありません）</div>`;
      return;
    }

    const html = items.map(item => {
      const checked = selectedIds.has(item.id) ? "checked" : "";
      const isPending = (item.scope === "pending") || (activeTab === "pending");
      const badgeScope = (activeTab === "all")
        ? (isPending ? `<span class="badge badgePending">pending</span>` : `<span class="badge badgePublic">public</span>`)
        : (activeTab === "pending" ? `<span class="badge badgePending">pending</span>` : `<span class="badge badgePublic">public</span>`);

      const metaParts = [];
      if (item.mode) metaParts.push(`<span class="badge">mode: ${escapeHtml(item.mode)}</span>`);
      if (item.bucket != null && item.bucket !== "") metaParts.push(`<span class="badge">bucket: ${escapeHtml(item.bucket)}</span>`);
      metaParts.push(`<span class="badge">likes: ${escapeHtml(item.likes)}</span>`);
      if (item.penName) metaParts.push(`<span class="badge">pen: ${escapeHtml(item.penName)}</span>`);
      const ts = formatTs(item.createdAt);
      if (ts) metaParts.push(`<span class="badge">${escapeHtml(ts)}</span>`);

      const text = item.text || "";
      const tooLong = text.length > 240;
      const textHtml = tooLong
        ? `<details><summary>本文を展開（${text.length}文字）</summary><div class="itemText">${escapeHtml(text)}</div></details>`
        : `<div class="itemText">${escapeHtml(text)}</div>`;

      // ✅ 要望：ボタンは承認/却下（却下は削除まで）
      const perActions = [];
      if (item.scope === "seed-local"){
        // 元ネタは表示のみ
      } else if (isPending){
        perActions.push(`<button class="smallBtn btnOk" data-act="approve" data-id="${escapeAttr(item.id)}">承認</button>`);
        perActions.push(`<button class="smallBtn btnDanger" data-act="reject" data-id="${escapeAttr(item.id)}">却下（→削除）</button>`);
      } else {
        // 公開側はここでは操作しない（要望に合わせてボタンを出さない）
      }

      return `
        <div class="item" data-item="${escapeAttr(item.id)}">
          <div class="itemTop">
            <div class="itemMeta">
              <label style="margin:0; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" class="chk itemChk" data-id="${escapeAttr(item.id)}" ${checked} />
                <span class="muted mono">${escapeHtml(item.id)}</span>
              </label>
              ${badgeScope}
              ${metaParts.join("")}
            </div>
            <div class="actions">${perActions.join("")}</div>
          </div>
          ${textHtml}
        </div>
      `;
    }).join("");

    listEl.innerHTML = html;
  }

  // -------------------------
  // 設定
  // -------------------------
  function saveSettings(){
    localStorage.setItem(LS_API, apiBase() || DEFAULT_API_BASE);
    localStorage.setItem(LS_KEY, adminKey() || "");
  }

  function loadSettings(){
    const a = localStorage.getItem(LS_API) || DEFAULT_API_BASE;
    const k = localStorage.getItem(LS_KEY) || "";
    elApiBase.value = a;
    elAdminKey.value = k;
  }

  // -------------------------
  // APIロード
  // -------------------------
  async function doHealth(){
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      const data = await fetchJSON("/api/health", { signal:getSignal() });
      const kv = (data.kv === true) ? "kv:OK" : "kv:?" ;
      setPill(pillHealth, `health: OK (${kv})`, true);

      try{
        await fetchJSON("/api/admin/pending", { admin:true, signal:getSignal() });
        setPill(pillAdmin, "admin: OK", true);
      } catch(e){
        if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
        else setPill(pillAdmin, `admin: NG（${e.message}）`, false);
      }
    } catch(e){
      setPill(pillHealth, `health: NG（${e.message}）`, false);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function loadPending(){
    const data = await fetchJSON("/api/admin/pending", { admin:true, signal:getSignal() });
    itemsPending = normalizeItems(data.items || data.pending || [], "pending");
  }
  async function loadPublic(){
    const data = await fetchJSON("/api/admin/list", { admin:true, signal:getSignal() });
    itemsPublic = normalizeItems(data.items || data.list || data.public || [], "public");
  }
  async function loadAll(){
    const data = await fetchJSON("/api/admin/all?scope=both", { admin:true, signal:getSignal() });
    const raw = data.items || data.all || [];
    const kvAll = normalizeItems(raw, "");
    loadSeedLocalFromMetaphorsJS();
    const kvIds = new Set(kvAll.map(x => x.id));
    const seed = itemsSeedLocal.filter(x => !kvIds.has(x.id));
    itemsAll = kvAll.concat(seed);
  }

  async function refreshCurrentTab(){
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      if (activeTab === "pending") await loadPending();
      else if (activeTab === "public") await loadPublic();
      else await loadAll();
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`更新に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function refreshAllTabs(){
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      await Promise.all([loadPending(), loadPublic(), loadAll()]);
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`更新に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  function getSelectedIds(){ return Array.from(selectedIds); }

  // -------------------------
  // 承認・却下（却下は削除まで）
  // -------------------------
  async function approveIds(ids){
    if (!ids.length) return;
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      // approve系の候補（404でも順番に試す）
      await postWithFallback(
        ["/api/admin/approve", "/api/admin/approvePending", "/api/admin/approve_pending", "/api/admin/publish"],
        { ids }
      );
      await refreshAllTabs();
      selectedIds = new Set();
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`承認に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function rejectThenDeleteIds(ids){
    if (!ids.length) return;
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      // reject系（404でも順番に試す）
      try{
        await postWithFallback(
          ["/api/admin/reject", "/api/admin/rejectPending", "/api/admin/reject_pending"],
          { ids }
        );
      } catch(e){
        // rejectが無い環境もあるので、ここでは「削除だけでも実行」する
        if (e?.status !== 404) throw e;
      }

      // ✅ 要望：却下されたら削除（pendingから消す）
      await postWithFallback(
        ["/api/admin/delete", "/api/admin/deletePending", "/api/admin/delete_pending"],
        { ids, scope:"pending" }
      );

      await refreshAllTabs();
      selectedIds = new Set();
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`却下/削除に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  // -------------------------
  // 初期ネタ取り込み（1クリックで全部、内部で12件ずつ分割）
  // -------------------------
  async function importSeed(){
    const ENDPOINTS = ["/api/admin/import_seed", "/api/admin/importSeed", "/api/admin/import_seed_items"];
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);

    try{
      // metaphors.js のあなた形式からフラット化
      loadSeedLocalFromMetaphorsJS();
      const src = itemsSeedLocal
        .filter(x => x.scope === "seed-local")
        .map(x => ({ mode:x.mode, bucket:Number(x.bucket)||0, text:String(x.text||"").trim() }))
        .filter(x => x.text);

      if (!src.length) throw new Error("metaphors.js から初期ネタを抽出できませんでした（NETA_TRIVIA/NETA が空）");

      const BATCH = 12;
      let imported = 0;

      for (let i = 0; i < src.length; i += BATCH){
        const chunk = src.slice(i, i + BATCH);

        // import_seedも環境差があるのでfallback
        await postWithFallback(ENDPOINTS, { items: chunk });

        imported += chunk.length;
      }

      await refreshAllTabs();
      alert(`初期ネタを取り込みました（${imported}件）`);
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`初期ネタ取り込みに失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  // -------------------------
  // イベント
  // -------------------------
  btnSave.addEventListener("click", () => {
    saveSettings();
    alert("保存しました（このブラウザに記憶）");
  });

  btnHealth.addEventListener("click", doHealth);
  btnRefresh.addEventListener("click", refreshCurrentTab);
  btnRefreshAllTabs.addEventListener("click", refreshAllTabs);
  btnImportSeed.addEventListener("click", importSeed);

  tabPending.addEventListener("click", () => setActiveTab("pending"));
  tabPublic.addEventListener("click",  () => setActiveTab("public"));
  tabAll.addEventListener("click",     () => setActiveTab("all"));

  chkAll.addEventListener("change", () => {
    const items = getActiveItems();
    if (chkAll.checked){
      items.forEach(x => selectedIds.add(x.id));
    } else {
      items.forEach(x => selectedIds.delete(x.id));
    }
    updateSelectionUI();
    listEl.querySelectorAll(".itemChk").forEach(chk => {
      const id = chk.getAttribute("data-id");
      chk.checked = selectedIds.has(id);
    });
  });

  btnBulkApprove.addEventListener("click", async () => {
    const ids = getSelectedIds();
    if (!ids.length) return alert("選択がありません");
    if (!confirm(`選択 ${ids.length}件 を承認しますか？`)) return;
    await approveIds(ids);
  });

  btnBulkReject.addEventListener("click", async () => {
    const ids = getSelectedIds();
    if (!ids.length) return alert("選択がありません");
    if (!confirm(`選択 ${ids.length}件 を却下して削除しますか？（pendingから消えます）`)) return;
    await rejectThenDeleteIds(ids);
  });

  // リスト内クリック（委譲）
  listEl.addEventListener("click", async (ev) => {
    const raw = ev.target;
    if (!raw) return;

    const el = (raw instanceof Element) ? raw.closest("button[data-act], input.itemChk") : null;
    if (!el) return;

    if (el instanceof HTMLInputElement && el.classList.contains("itemChk")) {
      const id = el.getAttribute("data-id");
      if (!id) return;
      if (el.checked) selectedIds.add(id);
      else selectedIds.delete(id);
      updateSelectionUI();
      return;
    }

    if (el instanceof HTMLButtonElement) {
      const act = el.getAttribute("data-act");
      const id  = el.getAttribute("data-id");
      if (!act || !id) return;

      if (act === "approve") {
        if (!confirm("この1件を承認しますか？")) return;
        await approveIds([id]);
      } else if (act === "reject") {
        if (!confirm("この1件を却下して削除しますか？")) return;
        await rejectThenDeleteIds([id]);
      }
    }
  });

  // 初期化
  loadSettings();
  setPill(pillHealth, "health: 未確認", null);
  setPill(pillAdmin,  "admin: 未確認", null);
  render();
})();
</script>
</body>
</html>
<!-- # END -->
