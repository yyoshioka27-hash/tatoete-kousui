<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>承認待ち（管理者）</title>
  <style>
    body{ font-family: system-ui; padding:16px; }
    input,button{ padding:10px 12px; border-radius:10px; border:1px solid #ddd; }
    button{ cursor:pointer; }
    .row{ display:flex; justify-content:space-between; gap:10px; padding:10px; border-top:1px solid #eee; }
    .muted{ color:#64748b; font-size:12px; }
    .text{ white-space:pre-wrap; }
  </style>
</head>
<body>
  <h2>承認待ち一覧</h2>

  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <input id="key" placeholder="管理者キー（x-admin-key）" style="min-width:260px;">
    <button id="reload">更新</button>
    <span id="status" class="muted"></span>
  </div>

  <div id="list" style="margin-top:14px;"></div>

<script>
const API_BASE = "https://ancient-union-4aa4tatoete-kousui-api.y-yoshioka27.workers.dev";

const $ = (id)=>document.getElementById(id);
function setStatus(t){ $("status").textContent = t; }

async function api(path, method="GET", body=null){
  const key = $("key").value.trim();
  const opt = { method, headers: { "Content-Type":"application/json", "x-admin-key": key } };
  if (body) opt.body = JSON.stringify(body);
  const res = await fetch(API_BASE + path, opt);
  const data = await res.json().catch(()=>null);
  if (!res.ok) throw new Error(data?.error || ("HTTP " + res.status));
  if (!data?.ok) throw new Error("not ok");
  return data;
}

async function load(){
  setStatus("取得中…");
  const out = await api("/api/pending");
  const items = out.items || [];
  setStatus(`承認待ち：${items.length}件`);
  const list = $("list");
  list.innerHTML = "";

  if (!items.length){
    list.innerHTML = `<div class="muted">承認待ちはありません。</div>`;
    return;
  }

  for (const it of items){
    const row = document.createElement("div");
    row.className = "row";

    const left = document.createElement("div");
    left.style.flex = "1";

    const t = document.createElement("div");
    t.className = "text";
    t.textContent = it.text;

    const m = document.createElement("div");
    m.className = "muted";
    m.textContent = `mode:${it.mode} / bucket:${it.bucket}% / from:${it.from||"-"} / ${new Date(it.createdAt||0).toLocaleString()} / id:${it.id}`;

    left.appendChild(t);
    left.appendChild(m);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.alignItems = "center";

    const ok = document.createElement("button");
    ok.textContent = "✅ 承認";
    ok.onclick = async ()=>{
      if(!confirm("承認して公開します。よろしいですか？")) return;
      await api("/api/approve", "POST", { id: it.id });
      await load();
    };

    const ng = document.createElement("button");
    ng.textContent = "❌ 却下";
    ng.onclick = async ()=>{
      if(!confirm("却下して削除します。よろしいですか？")) return;
      await api("/api/reject", "POST", { id: it.id });
      await load();
    };

    right.appendChild(ok);
    right.appendChild(ng);

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  }
}

$("reload").onclick = ()=>load();

setStatus("管理者キーを入れて「更新」");
</script>
</body>
</html>
