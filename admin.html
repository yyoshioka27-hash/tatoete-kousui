<!-- admin.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <title>管理（承認待ち／一般公開）</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --sub:#64748b;
      --line:rgba(15,23,42,.12);
      --card:#ffffff;
      --shadow:0 10px 24px rgba(2,6,23,.08);
      --blue:#2563eb;
      --red:#ef4444;
      --green:#16a34a;
      --btn:#0f172a;
      --btnText:#fff;
      --mutedBg:rgba(15,23,42,.04);
      --radius:16px;
    }
    body{
      margin:0;
      padding:18px;
      font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{ max-width:980px; margin:0 auto; }
    h1{ margin:6px 0 16px; font-size:24px; letter-spacing:-.2px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin:12px 0;
    }
    .muted{ color:var(--sub); font-size:12px; }
    label{ font-size:12px; color:var(--sub); display:block; margin-bottom:6px; }
    input, select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      min-width:280px;
      font-size:14px;
      background:#fff;
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,0.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.12);
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:14px;
      user-select:none;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .btnPrimary{
      background:var(--blue);
      color:#fff;
      border-color:rgba(37,99,235,0.55);
      font-weight:800;
    }
    .btnDanger{
      background:var(--red);
      color:#fff;
      border-color:rgba(239,68,68,.6);
      font-weight:800;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--mutedBg);
      font-size:12px;
    }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tab{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
    }
    .tab.active{
      background:var(--btn);
      color:var(--btnText);
      border-color:rgba(15,23,42,.35);
    }
    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 0 0;
      border-top:1px solid rgba(15,23,42,.08);
      margin-top:10px;
    }
    .list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.9);
    }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .itemText{ font-size:15px; line-height:1.55; font-weight:700; margin:8px 0; white-space:pre-wrap; }
    .itemMeta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.75);
      font-size:12px;
      color:var(--sub);
      font-weight:800;
    }
    .badgePublic{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.07); color: #166534; }
    .badgePending{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.07); color: #991b1b; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chk{ transform:translateY(1px); }
    .right{ margin-left:auto; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
<div class="container">
  <h1>管理（承認待ち／一般公開）</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>API_BASE</label>
        <input id="apiBase" class="mono" />
      </div>
      <div>
        <label>ADMIN_KEY</label>
        <input id="adminKey" class="mono" placeholder="例：2355" />
      </div>

      <div class="row" style="gap:8px; align-items:flex-end;">
        <button id="btnSave" class="btnPrimary">保存</button>
        <button id="btnHealth">health</button>
        <button id="btnRefresh">更新（表示中タブ）</button>
        <button id="btnImportSeed">初期ネタを取り込み</button>
      </div>

      <div class="right row" style="gap:8px;">
        <span class="pill" id="pillHealth">health: 未確認</span>
        <span class="pill" id="pillAdmin">admin: 未確認</span>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ※ 管理操作は <span class="mono">x-admin-key</span> ヘッダで送ります。<span class="mono">ADMIN_KEY</span> が間違うと 403 になります。
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="tabs">
        <button id="tabPending" class="tab active">承認待ち</button>
        <button id="tabPublic" class="tab">一般公開</button>
        <button id="tabAll" class="tab">全ネタ（public+pending）</button>
      </div>
      <div class="muted" id="counts">承認待ち: 0件 / 公開: 0件 / 全: 0件</div>
    </div>

    <div class="toolbar">
      <div class="row" style="gap:12px;">
        <label style="margin:0; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="chkAll" class="chk" />
          全選択
        </label>
        <span class="pill" id="selCount">選択: 0件</span>
      </div>
      <div class="actions">
        <button id="btnBulkApprove" class="btnPrimary">一括承認</button>
        <button id="btnBulkReject" class="btnDanger">一括却下</button>
        <button id="btnBulkDelete" class="btnDanger" style="display:none;">選択を削除</button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ※ 承認待ち: <span class="mono">/api/admin/pending</span> / 承認: <span class="mono">/api/admin/approve</span> / 却下: <span class="mono">/api/admin/reject</span><br/>
      ※ 公開: <span class="mono">/api/admin/list</span> / 削除: <span class="mono">/api/admin/delete</span><br/>
      ※ 全ネタ: <span class="mono">/api/admin/all?scope=both</span>（表示のみ） / 削除: <span class="mono">/api/admin/delete</span>
    </div>

    <div class="list" id="list"></div>
  </div>

  <div class="muted" style="text-align:center; margin:14px 0 8px;">
    admin.html（堅牢版） / # END
  </div>
</div>

<script>
(() => {
  // -----------------------
  // 設定
  // -----------------------
  const DEFAULT_API_BASE = "https://ancient-union-4aa4tatoete-kousui-api.y-yoshioka27.workers.dev";
  const LS_API = "tatoete_admin_api_base";
  const LS_KEY = "tatoete_admin_key";

  const $ = (id) => document.getElementById(id);

  const elApiBase = $("apiBase");
  const elAdminKey = $("adminKey");
  const pillHealth = $("pillHealth");
  const pillAdmin  = $("pillAdmin");
  const countsEl   = $("counts");
  const listEl     = $("list");

  const tabPending = $("tabPending");
  const tabPublic  = $("tabPublic");
  const tabAll     = $("tabAll");

  const chkAll     = $("chkAll");
  const selCount   = $("selCount");

  const btnSave    = $("btnSave");
  const btnHealth  = $("btnHealth");
  const btnRefresh = $("btnRefresh");
  const btnImportSeed = $("btnImportSeed");

  const btnBulkApprove = $("btnBulkApprove");
  const btnBulkReject  = $("btnBulkReject");
  const btnBulkDelete  = $("btnBulkDelete");

  let activeTab = "pending"; // pending | public | all
  let itemsPending = [];
  let itemsPublic  = [];
  let itemsAll     = []; // { ...it, status:"public"|"pending" }
  let selectedIds = new Set();

  function apiBase(){
    return String(elApiBase.value || "").trim().replace(/\/+$/,"");
  }
  function adminKey(){
    return String(elAdminKey.value || "").trim();
  }

  function setPill(el, text, ok=null){
    el.textContent = text;
    el.style.borderColor = ok===true ? "rgba(22,163,74,.45)"
                      : ok===false ? "rgba(239,68,68,.45)"
                      : "rgba(15,23,42,.12)";
    el.style.background = ok===true ? "rgba(22,163,74,.08)"
                      : ok===false ? "rgba(239,68,68,.08)"
                      : "rgba(15,23,42,.04)";
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtTime(ts){
    if (!ts) return "--";
    try{
      const d = new Date(Number(ts));
      return d.toLocaleString("ja-JP");
    }catch{ return "--"; }
  }

  // -----------------------
  // API
  // -----------------------
  async function apiGet(path){
    const res = await fetch(`${apiBase()}${path}`, {
      method: "GET",
      headers: adminKey() ? { "x-admin-key": adminKey() } : {}
    });
    const data = await res.json().catch(() => null);
    if (!res.ok || !data?.ok) {
      const msg = data?.error || data?.message || `${path} failed ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  async function apiPost(path, body){
    const res = await fetch(`${apiBase()}${path}`, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        ...(adminKey() ? { "x-admin-key": adminKey() } : {})
      },
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(() => null);
    if (!res.ok || !data?.ok) {
      const msg = data?.error || data?.message || `${path} failed ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  // -----------------------
  // 表示
  // -----------------------
  function renderCounts(){
    countsEl.textContent = `承認待ち: ${itemsPending.length}件 / 公開: ${itemsPublic.length}件 / 全: ${itemsAll.length}件`;
  }

  function updateSelUI(){
    selCount.textContent = `選択: ${selectedIds.size}件`;
  }

  function getActiveItems(){
    if (activeTab==="pending") return itemsPending;
    if (activeTab==="public")  return itemsPublic;
    return itemsAll;
  }

  function statusOfIdInAll(id){
    const hit = itemsAll.find(x => x && x.id === id);
    return hit?.status || null;
  }

  function setTab(tab){
    activeTab = tab;
    selectedIds.clear();
    chkAll.checked = false;

    tabPending.classList.toggle("active", tab==="pending");
    tabPublic.classList.toggle("active",  tab==="public");
    tabAll.classList.toggle("active",     tab==="all");

    // 削除ボタン：public / all で表示
    btnBulkDelete.style.display = (tab==="public" || tab==="all") ? "" : "none";
    // 承認/却下ボタン：pending / all で表示（allの場合は pendingだけに適用する）
    btnBulkApprove.style.display = (tab==="pending" || tab==="all") ? "" : "none";
    btnBulkReject.style.display  = (tab==="pending" || tab==="all") ? "" : "none";

    renderList();
  }

  function renderList(){
    const items = getActiveItems();
    renderCounts();
    updateSelUI();

    if (!items.length){
      listEl.innerHTML = `<div class="muted">表示するデータがありません。</div>`;
      return;
    }

    listEl.innerHTML = items.map(it => {
      const idRaw = it.id || "";
      const id = escapeHtml(idRaw);
      const text = escapeHtml(it.text || "");
      const mode = escapeHtml(it.mode || "");
      const bucket = escapeHtml(String(it.bucket ?? ""));
      const pen = escapeHtml(it.penName || "匿名");
      const createdAt = fmtTime(it.createdAt);
      const approvedAt = fmtTime(it.approvedAt);

      const checked = selectedIds.has(idRaw) ? "checked" : "";

      const status = it.status || (activeTab==="pending" ? "pending" : (activeTab==="public" ? "public" : ""));
      const statusBadge = (activeTab==="all")
        ? (status === "public"
            ? `<span class="badge badgePublic">公開</span>`
            : `<span class="badge badgePending">承認待ち</span>`)
        : "";

      const topBadges = [
        statusBadge,
        `<span class="badge">mode: ${mode}</span>`,
        `<span class="badge">bucket: ${bucket}</span>`,
        `<span class="badge">pen: ${pen}</span>`,
        `<span class="badge">id: <span class="mono">${id}</span></span>`
      ].filter(Boolean).join(" ");

      const timeBadges =
        (activeTab==="pending")
          ? `<span class="badge">created: ${createdAt}</span>`
          : (activeTab==="public")
            ? `<span class="badge">approved: ${approvedAt}</span><span class="badge">created: ${createdAt}</span>`
            : (status === "pending"
                ? `<span class="badge">created: ${createdAt}</span>`
                : `<span class="badge">approved: ${approvedAt}</span><span class="badge">created: ${createdAt}</span>`);

      let actionBtns = "";
      if (activeTab === "pending") {
        actionBtns = `
          <button class="btnPrimary" data-act="approve" data-id="${id}">承認</button>
          <button class="btnDanger" data-act="reject" data-id="${id}">却下</button>
          <button class="btnDanger" data-act="delete" data-id="${id}">削除</button>
        `;
      } else if (activeTab === "public") {
        actionBtns = `<button class="btnDanger" data-act="delete" data-id="${id}">削除</button>`;
      } else {
        if (status === "pending") {
          actionBtns += `<button class="btnPrimary" data-act="approve" data-id="${id}">承認</button>
                         <button class="btnDanger" data-act="reject" data-id="${id}">却下</button>`;
        }
        actionBtns += `<button class="btnDanger" data-act="delete" data-id="${id}">削除</button>`;
      }

      return `
        <div class="item">
          <div class="itemTop">
            <label style="margin:0; display:flex; align-items:center; gap:8px;">
              <input type="checkbox" class="chk" data-act="toggle" data-id="${id}" ${checked} />
              選択
            </label>
            <div class="itemMeta">${topBadges}</div>
          </div>

          <div class="itemText">${text}</div>

          <div class="row" style="justify-content:space-between;">
            <div class="itemMeta">${timeBadges}</div>
            <div class="actions">${actionBtns}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  // クリック委譲（リスト上のボタン/チェック）
  listEl.addEventListener("click", async (ev) => {
    const t = ev.target;
    if (!t) return;

    const act = t.getAttribute("data-act");
    const id  = t.getAttribute("data-id");
    if (!act || !id) return;

    if (act === "toggle"){
      if (selectedIds.has(id)) selectedIds.delete(id);
      else selectedIds.add(id);
      updateSelUI();

      const items2 = getActiveItems();
      chkAll.checked = (items2.length > 0 && selectedIds.size === items2.length);
      return;
    }

    try{
      if (act === "approve"){
        if (!confirm(`承認しますか？\n${id}`)) return;
        await apiPost("/api/admin/approve", { id });
        await Promise.all([refreshPending(), refreshPublic(), refreshAll()]);
        renderList();
        return;
      }

      if (act === "reject"){
        if (!confirm(`却下しますか？\n${id}`)) return;
        await apiPost("/api/admin/reject", { id });
        await Promise.all([refreshPending(), refreshAll()]);
        renderList();
        return;
      }

      if (act === "delete"){
        if (!confirm(`削除しますか？\n${id}`)) return;

        // scope: public / pending / both（allタブ）
        let scope = "public";
        if (activeTab === "pending") scope = "pending";
        else if (activeTab === "all") scope = "both";

        await apiPost("/api/admin/delete", { id, scope });
        await Promise.all([refreshPending(), refreshPublic(), refreshAll()]);
        renderList();
        return;
      }
    }catch(e){
      alert(`操作失敗：${e?.message || e}`);
    }
  });

  // -----------------------
  // health / refresh
  // -----------------------
  async function doHealth(){
    await apiGet("/api/health");
    setPill(pillHealth, "health: OK", true);

    try{
      await apiGet("/api/admin/check");
      setPill(pillAdmin, "admin: OK", true);
    }catch{
      setPill(pillAdmin, "admin: NG", false);
    }
  }

  async function refreshPending(){
    const data = await apiGet("/api/admin/pending");
    itemsPending = Array.isArray(data.items) ? data.items : [];
    renderCounts();
  }

  async function refreshPublic(){
    const data = await apiGet("/api/admin/list?limit=5000");
    itemsPublic = Array.isArray(data.items) ? data.items : [];
    renderCounts();
  }

  async function refreshAll(){
    const data = await apiGet("/api/admin/all?scope=both&limit=5000");
    itemsAll = Array.isArray(data.items) ? data.items : [];
    renderCounts();
  }

  async function refreshActive(){
    if (activeTab === "pending") return refreshPending();
    if (activeTab === "public")  return refreshPublic();
    return refreshAll();
  }

  // -----------------------
  // 一括操作
  // -----------------------
  chkAll.addEventListener("change", () => {
    const items = getActiveItems();
    selectedIds.clear();
    if (chkAll.checked){
      for (const it of items) if (it?.id) selectedIds.add(it.id);
    }
    renderList();
  });

  btnBulkApprove.addEventListener("click", async () => {
    const ids0 = Array.from(selectedIds);
    if (!ids0.length) return alert("選択が0件です");

    const ids = (activeTab === "all")
      ? ids0.filter(id => statusOfIdInAll(id) === "pending")
      : ids0;

    if (!ids.length) return alert("承認できる（承認待ちの）選択がありません");
    if (!confirm(`一括承認しますか？\n${ids.length}件`)) return;

    btnBulkApprove.disabled = true;
    try{
      for (const id of ids){
        await apiPost("/api/admin/approve", { id });
      }
      selectedIds.clear();
      chkAll.checked = false;
      await Promise.all([refreshPending(), refreshPublic(), refreshAll()]);
      renderList();
    }catch(e){
      alert(`一括承認失敗：${e?.message || e}`);
    }finally{
      btnBulkApprove.disabled = false;
    }
  });

  btnBulkReject.addEventListener("click", async () => {
    const ids0 = Array.from(selectedIds);
    if (!ids0.length) return alert("選択が0件です");

    const ids = (activeTab === "all")
      ? ids0.filter(id => statusOfIdInAll(id) === "pending")
      : ids0;

    if (!ids.length) return alert("却下できる（承認待ちの）選択がありません");
    if (!confirm(`一括却下しますか？\n${ids.length}件`)) return;

    btnBulkReject.disabled = true;
    try{
      for (const id of ids){
        await apiPost("/api/admin/reject", { id });
      }
      selectedIds.clear();
      chkAll.checked = false;
      await Promise.all([refreshPending(), refreshPublic(), refreshAll()]);
      renderList();
    }catch(e){
      alert(`一括却下失敗：${e?.message || e}`);
    }finally{
      btnBulkReject.disabled = false;
    }
  });

  btnBulkDelete.addEventListener("click", async () => {
    const ids = Array.from(selectedIds);
    if (!ids.length) return alert("選択が0件です");
    if (!confirm(`選択を削除しますか？\n${ids.length}件`)) return;

    btnBulkDelete.disabled = true;
    try{
      for (const id of ids){
        let scope = "public";
        if (activeTab === "pending") scope = "pending";
        else if (activeTab === "all") scope = "both";
        await apiPost("/api/admin/delete", { id, scope });
      }
      selectedIds.clear();
      chkAll.checked = false;
      await Promise.all([refreshPending(), refreshPublic(), refreshAll()]);
      renderList();
    }catch(e){
      alert(`一括削除失敗：${e?.message || e}`);
    }finally{
      btnBulkDelete.disabled = false;
    }
  });

  // -----------------------
  // 初期ネタ取り込み（metaphors.js -> KV）
  // -----------------------
  async function importSeed(){
    if (!confirm("metaphors.js の初期ネタをKVへ取り込みます。よろしいですか？")) return;

    btnImportSeed.disabled = true;
    btnImportSeed.textContent = "取り込み中...";

    try{
      // 1) metaphors.js を取得（同一GitHub Pages上）
      const res = await fetch("./metaphors.js", { cache: "no-store" });
      if (!res.ok) throw new Error(`metaphors.js が読めません（${res.status}）`);
      const code = await res.text();

      // 2) 一時windowに評価（metaphors.js は window.NETA_TRIVIA / window.NETA を定義する想定）
      const tmp = {};
      (function(window){ eval(code); })(tmp);

      const items = [];

      const t = tmp.NETA_TRIVIA || {};
      Object.keys(t).forEach(k => {
        const bucket = Number(k);
        (t[k] || []).forEach(text => items.push({ mode:"trivia", bucket, text }));
      });

      const f = tmp.NETA || {};
      Object.keys(f).forEach(k => {
        const bucket = Number(k);
        (f[k] || []).forEach(text => items.push({ mode:"fun", bucket, text }));
      });

      if (!items.length) throw new Error("初期ネタが見つかりません（NETA_TRIVIA / NETA が空）");

      // 3) Workerへ送信
      // ✅ ここが Network に POST /api/admin/import_seed として出ます
      const r = await apiPost("/api/admin/import_seed", { items });

      alert(`取り込み完了：追加 ${r.put} 件 / スキップ ${r.skipped} 件`);

      await Promise.all([refreshPending(), refreshPublic(), refreshAll()]);
      renderList();
    }catch(e){
      alert(`取り込み失敗：${e?.message || e}`);
      console.error(e);
    }finally{
      btnImportSeed.disabled = false;
      btnImportSeed.textContent = "初期ネタを取り込み";
    }
  }

  // -----------------------
  // UIイベント
  // -----------------------
  btnSave.addEventListener("click", () => {
    localStorage.setItem(LS_API, apiBase());
    localStorage.setItem(LS_KEY, adminKey());
    alert("保存しました");
  });

  btnHealth.addEventListener("click", async () => {
    try{
      await doHealth();
      alert("health OK");
    }catch(e){
      alert(`health NG：${e?.message || e}`);
    }
  });

  btnRefresh.addEventListener("click", async () => {
    try{
      await doHealth();
      await refreshActive();
      renderList();
    }catch(e){
      alert(`更新失敗：${e?.message || e}`);
    }
  });

  btnImportSeed.addEventListener("click", importSeed);

  tabPending.addEventListener("click", () => setTab("pending"));
  tabPublic.addEventListener("click",  () => setTab("public"));
  tabAll.addEventListener("click",     () => setTab("all"));

  // -----------------------
  // 初期化
  // -----------------------
  async function init(){
    elApiBase.value  = localStorage.getItem(LS_API) || DEFAULT_API_BASE;
    elAdminKey.value = localStorage.getItem(LS_KEY) || "";

    setPill(pillHealth, "health: 未確認", null);
    setPill(pillAdmin,  "admin: 未確認", null);

    try{
      await doHealth();
      await Promise.all([refreshPending(), refreshPublic(), refreshAll()]);
    }catch(e){
      console.warn(e);
    }finally{
      renderList();
    }
  }

  if (document.readyState === "loading") {
    window.addEventListener("DOMContentLoaded", init, { once:true });
  } else {
    init();
  }
})();
</script>

</body>
</html>
