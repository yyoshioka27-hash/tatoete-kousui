<!-- admin.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <title>管理（承認待ち／一般公開）</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --sub:#64748b;
      --line:rgba(15,23,42,.12);
      --card:#ffffff;
      --shadow:0 10px 24px rgba(2,6,23,.08);
      --blue:#2563eb;
      --red:#ef4444;
      --green:#16a34a;
      --btn:#0f172a;
      --btnText:#fff;
      --mutedBg:rgba(15,23,42,.04);
      --radius:16px;
    }
    body{ margin:0; padding:18px; font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
    .container{ max-width:980px; margin:0 auto; }
    h1{ margin:6px 0 16px; font-size:24px; letter-spacing:-.2px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin:12px 0; }
    .muted{ color:var(--sub); font-size:12px; }
    label{ font-size:12px; color:var(--sub); display:block; margin-bottom:6px; }
    input{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); min-width:280px; font-size:14px; background:#fff; outline:none; }
    input:focus{ border-color: rgba(37,99,235,0.55); box-shadow: 0 0 0 4px rgba(37,99,235,0.12); }
    button{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer; font-size:14px; user-select:none; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .btnPrimary{ background:var(--blue); color:#fff; border-color:rgba(37,99,235,0.55); font-weight:800; }
    .btnDanger{ background:var(--red); color:#fff; border-color:rgba(239,68,68,.6); font-weight:800; }
    .btnOk{ background:var(--green); color:#fff; border-color: rgba(22,163,74,.6); font-weight:800; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--mutedBg); font-size:12px; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tab{ padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; font-weight:800; }
    .tab.active{ background:var(--btn); color:var(--btnText); border-color:rgba(15,23,42,.35); }
    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; padding:10px 0 0; border-top:1px solid rgba(15,23,42,.08); margin-top:10px; }
    .list{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .item{ border:1px solid rgba(15,23,42,.10); border-radius:14px; padding:12px; background:rgba(255,255,255,.9); }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .itemText{ font-size:15px; line-height:1.55; font-weight:700; margin:8px 0; white-space:pre-wrap; }
    .itemMeta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid rgba(15,23,42,.12); background:rgba(255,255,255,.75); font-size:12px; color:var(--sub); font-weight:800; }
    .badgePublic{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.07); color: #166534; }
    .badgePending{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.07); color: #991b1b; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chk{ transform:translateY(1px); }
    .right{ margin-left:auto; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .smallBtn{ padding:8px 10px; border-radius:10px; font-size:13px; }
  </style>

  <!-- ✅ 元ネタ（metaphors.js） -->
  <script src="./metaphors.js"></script>
</head>

<body>
<div class="container">
  <h1>管理（承認待ち／一般公開）</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>API_BASE</label>
        <input id="apiBase" class="mono" />
      </div>
      <div>
        <label>ADMIN_KEY</label>
        <input id="adminKey" class="mono" placeholder="例：2355" />
      </div>

      <div class="row" style="gap:8px; align-items:flex-end;">
        <button id="btnSave" class="btnPrimary">保存</button>
        <button id="btnHealth">health</button>
        <button id="btnRefresh">更新（表示中タブ）</button>
        <button id="btnRefreshAllTabs">更新（全タブ）</button>
      </div>

      <div class="right row" style="gap:8px;">
        <span class="pill" id="pillHealth">health: 未確認</span>
        <span class="pill" id="pillAdmin">admin: 未確認</span>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ※ 管理操作は <span class="mono">x-admin-key</span> ヘッダで送ります。<span class="mono">ADMIN_KEY</span> が間違うと 403 になります。
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="tabs">
        <button id="tabPending" class="tab active">承認待ち</button>
        <button id="tabPublic" class="tab">一般公開</button>
        <button id="tabAll" class="tab">全ネタ（public+pending）</button>
      </div>
      <div class="muted" id="counts">承認待ち: 0件 / 公開: 0件 / 全: 0件</div>
    </div>

    <div class="toolbar">
      <div class="row" style="gap:12px;">
        <label style="margin:0; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="chkAll" class="chk" />
          全選択
        </label>
        <span class="pill" id="selCount">選択: 0件</span>
        <span class="pill" id="pillBusy" style="display:none;">通信中…</span>
      </div>
      <div class="actions">
        <button id="btnBulkApprove" class="btnOk">一括承認</button>
        <button id="btnBulkReject" class="btnDanger">一括却下（＝削除）</button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ※ 承認待ち: <span class="mono">/api/admin/pending</span><br/>
      ※ 承認APIは環境差があるため、複数候補を自動で試します（404対策）<br/>
      ※ 却下は「reject → 効かなければ delete(pending)」で確実に消します
    </div>

    <div class="list" id="list"></div>
  </div>

  <div class="muted" style="text-align:center; margin:14px 0 8px;">
    admin.html（承認/却下のみ） / # END
  </div>
</div>

<script>
(() => {
  const DEFAULT_API_BASE = "https://ancient-union-4aa4tatoete-kousui-api.y-yoshioka27.workers.dev";
  const LS_API = "tatoete_admin_api_base";
  const LS_KEY = "tatoete_admin_key";

  const $ = (id) => document.getElementById(id);

  const elApiBase = $("apiBase");
  const elAdminKey = $("adminKey");
  const pillHealth = $("pillHealth");
  const pillAdmin  = $("pillAdmin");
  const countsEl   = $("counts");
  const listEl     = $("list");

  const tabPending = $("tabPending");
  const tabPublic  = $("tabPublic");
  const tabAll     = $("tabAll");

  const chkAll     = $("chkAll");
  const selCount   = $("selCount");
  const pillBusy   = $("pillBusy");

  const btnSave    = $("btnSave");
  const btnHealth  = $("btnHealth");
  const btnRefresh = $("btnRefresh");
  const btnRefreshAllTabs = $("btnRefreshAllTabs");

  const btnBulkApprove = $("btnBulkApprove");
  const btnBulkReject  = $("btnBulkReject");

  let activeTab = "pending"; // pending | public | all
  let itemsPending = [];
  let itemsPublic  = [];
  let itemsAll     = [];
  let selectedIds = new Set();

  // metaphors.js 表示（任意：allタブに混ぜる）
  let itemsSeedLocal = [];
  function hash32(str){
    let h = 2166136261;
    for (let i = 0; i < str.length; i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0).toString(16);
  }
  function loadSeedLocalFromMetaphorsJS(){
    const trivia = window.NETA_TRIVIA;
    const fun    = window.NETA;
    const out = [];
    function pushFromDict(dict, modeLabel){
      if (!dict || typeof dict !== "object") return;
      for (const k of Object.keys(dict)){
        const bucket = Number(k);
        if (!Number.isFinite(bucket)) continue;
        const arr = dict[k];
        if (!Array.isArray(arr)) continue;
        for (const t of arr){
          const text = String(t ?? "").trim();
          if (!text) continue;
          out.push({ mode: modeLabel, bucket, text });
        }
      }
    }
    pushFromDict(trivia, "trivia");
    pushFromDict(fun, "fun");
    itemsSeedLocal = out.map(x => ({
      id: "seedjs_" + hash32(`${x.mode}|${x.bucket}|${x.text}`),
      text: x.text,
      bucket: x.bucket,
      mode: x.mode,
      likes: 0,
      penName: "元ネタ(metaphors.js)",
      createdAt: 0,
      scope: "seed-local"
    }));
  }

  // in-flight制御
  let __busy = false;
  let __ctrl = null;

  function apiBase(){
    return String(elApiBase.value || "").trim().replace(/\/+$/,"");
  }
  function adminKey(){
    return String(elAdminKey.value || "").trim();
  }

  function setPill(el, text, ok=null){
    el.textContent = text;
    el.style.borderColor = ok===true ? "rgba(22,163,74,.45)"
                      : ok===false ? "rgba(239,68,68,.45)"
                      : "rgba(15,23,42,.20)";
  }

  function setBusy(on){
    __busy = !!on;
    pillBusy.style.display = __busy ? "inline-flex" : "none";
    const dis = __busy;
    [btnSave, btnHealth, btnRefresh, btnRefreshAllTabs,
     tabPending, tabPublic, tabAll,
     btnBulkApprove, btnBulkReject].forEach(b => { try{ b.disabled = dis; }catch{} });
  }

  function abortInFlight(){
    try{ if (__ctrl) __ctrl.abort(); }catch{}
    __ctrl = null;
    __busy = false;
    setBusy(false);
  }

  async function fetchJSON(path, { method="GET", body=null, admin=false, signal=null } = {}){
    const base = apiBase();
    if (!base) throw new Error("API_BASE が空です");

    const url = base + path;
    const headers = { "Content-Type":"application/json" };
    if (admin){
      const k = adminKey();
      if (!k) throw new Error("ADMIN_KEY が空です");
      headers["x-admin-key"] = k;
    }

    const res = await fetch(url, {
      method,
      headers,
      body: body ? JSON.stringify(body) : null,
      signal
    });

    const data = await res.json().catch(()=>null);

    // 404など「ok構造が無い」ケースも拾えるように
    if (!res.ok || !data?.ok){
      const msg = data?.error || `HTTP ${res.status}`;
      const e = new Error(msg);
      e.status = res.status;
      e.data = data;
      e.url = url;
      throw e;
    }
    return data;
  }

  // ✅ 404対策：複数エンドポイント／複数body形式を順に試す
  async function tryAdminPost(paths, bodyVariants, signal){
  let lastErr = null;
  for (const p of paths){
    for (const b of bodyVariants){
      try{
        const data = await fetchJSON(p, { method:"POST", admin:true, body:b, signal });
        return { ok:true, path:p, body:b, data };
      } catch(e){
        lastErr = e;
        if (e?.status === 403) throw e; // 鍵違いは即終了
        continue;
      }
    }
  }
  throw lastErr || new Error("操作に失敗しました");
}

    throw lastErr || new Error("操作に失敗しました");
  }

  function safeText(v){ return (v == null) ? "" : String(v); }

  function normalizeScope(x, fallback){
    const s = (x?.scope ?? x?._scope ?? x?.status ?? fallback ?? "").toString().toLowerCase().trim();
    if (s === "public" || s === "pending") return s;
    return fallback || "";
  }

  function normalizeItems(arr, fallbackScope){
    return (Array.isArray(arr) ? arr : []).map(x => {
      const scope = normalizeScope(x, fallbackScope || "");
      return {
        id: safeText(x.id ?? x.key ?? x._id ?? ""),
        text: safeText(x.text ?? x.metaphor ?? x.value ?? ""),
        bucket: (x.bucket ?? x.b ?? null),
        mode: safeText(x.mode ?? x.m ?? ""),
        likes: (x.likes ?? x.like ?? x.totalLikes ?? 0),
        penName: safeText(x.penName ?? x.pen ?? x.author ?? ""),
        createdAt: (x.createdAt ?? x.ts ?? x.time ?? x.approvedAt ?? 0),
        scope
      };
    }).filter(x => x.id);
  }

  function updateCounts(){
    countsEl.textContent = `承認待ち: ${itemsPending.length}件 / 公開: ${itemsPublic.length}件 / 全: ${itemsAll.length}件`;
  }

  function updateSelectionUI(){
    selCount.textContent = `選択: ${selectedIds.size}件`;
    const current = getActiveItems().filter(x => x.scope !== "seed-local");
    const allIds = current.map(x => x.id);
    const allSelected = allIds.length > 0 && allIds.every(id => selectedIds.has(id));
    chkAll.checked = allSelected;
    chkAll.indeterminate = (!allSelected && selectedIds.size > 0);
  }

  function setActiveTab(tab){
    activeTab = tab;
    tabPending.classList.toggle("active", tab==="pending");
    tabPublic.classList.toggle("active",  tab==="public");
    tabAll.classList.toggle("active",     tab==="all");
    selectedIds = new Set();
    render();
  }

  function getActiveItems(){
    if (activeTab === "pending") return itemsPending;
    if (activeTab === "public")  return itemsPublic;
    return itemsAll;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }

  function render(){
    updateCounts();
    const items = getActiveItems();
    updateSelectionUI();

    if (!items.length){
      listEl.innerHTML = `<div class="muted">（データがありません）</div>`;
      return;
    }

    const html = items.map(item => {
      const isSeedLocal = (item.scope === "seed-local");
      const checked = selectedIds.has(item.id) ? "checked" : "";
      const chkDisabled = isSeedLocal ? "disabled" : "";

      const isPending = (activeTab === "pending") || (item.scope === "pending");
      const badgeScope = (activeTab === "all")
        ? (isSeedLocal
            ? `<span class="badge">seed(local)</span>`
            : (isPending
                ? `<span class="badge badgePending">pending</span>`
                : `<span class="badge badgePublic">public</span>`))
        : (activeTab === "pending"
            ? `<span class="badge badgePending">pending</span>`
            : `<span class="badge badgePublic">public</span>`);

      const metaParts = [];
      if (item.mode) metaParts.push(`<span class="badge">mode: ${escapeHtml(item.mode)}</span>`);
      if (item.bucket != null && item.bucket !== "") metaParts.push(`<span class="badge">bucket: ${escapeHtml(item.bucket)}</span>`);
      metaParts.push(`<span class="badge">likes: ${escapeHtml(item.likes)}</span>`);
      if (item.penName) metaParts.push(`<span class="badge">pen: ${escapeHtml(item.penName)}</span>`);

      const text = item.text || "";
      const textHtml = `<div class="itemText">${escapeHtml(text)}</div>`;

      const perActions = [];
      // ✅ 要望：承認・却下だけ（pendingのときだけ表示）
      if (!isSeedLocal && activeTab === "pending"){
        perActions.push(`<button class="smallBtn btnOk" data-act="approve" data-id="${escapeAttr(item.id)}">承認</button>`);
        perActions.push(`<button class="smallBtn btnDanger" data-act="reject" data-id="${escapeAttr(item.id)}">却下（＝削除）</button>`);
      }

      return `
        <div class="item" data-item="${escapeAttr(item.id)}">
          <div class="itemTop">
            <div class="itemMeta">
              <label style="margin:0; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" class="chk itemChk" data-id="${escapeAttr(item.id)}" ${checked} ${chkDisabled} />
                <span class="muted mono">${escapeHtml(item.id)}</span>
              </label>
              ${badgeScope}
              ${metaParts.join("")}
            </div>
            <div class="actions">
              ${perActions.join("")}
            </div>
          </div>
          ${textHtml}
        </div>
      `;
    }).join("");

    listEl.innerHTML = html;
  }

  function saveSettings(){
    localStorage.setItem(LS_API, apiBase() || DEFAULT_API_BASE);
    localStorage.setItem(LS_KEY, adminKey() || "");
  }

  function loadSettings(){
    const a = localStorage.getItem(LS_API) || DEFAULT_API_BASE;
    const k = localStorage.getItem(LS_KEY) || "";
    elApiBase.value = a;
    elAdminKey.value = k;
  }

  async function doHealth(){
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      const data = await fetchJSON("/api/health", { signal: __ctrl.signal });
      const kv = (data.kv === true) ? "kv:OK" : "kv:?" ;
      setPill(pillHealth, `health: OK (${kv})`, true);

      try{
        await fetchJSON("/api/admin/pending", { admin:true, signal: __ctrl.signal });
        setPill(pillAdmin, "admin: OK", true);
      } catch(e){
        if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
        else setPill(pillAdmin, `admin: NG（${e.message}）`, false);
      }
    } catch(e){
      setPill(pillHealth, `health: NG（${e.message}）`, false);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function loadPending(){
    const data = await fetchJSON("/api/admin/pending", { admin:true, signal: __ctrl.signal });
    itemsPending = normalizeItems(data.items || data.pending || [], "pending");
  }
  async function loadPublic(){
    const data = await fetchJSON("/api/admin/list", { admin:true, signal: __ctrl.signal });
    itemsPublic = normalizeItems(data.items || data.list || data.public || [], "public");
  }
  async function loadAll(){
    const data = await fetchJSON("/api/admin/all?scope=both", { admin:true, signal: __ctrl.signal });
    const raw = data.items || data.all || [];
    const kvAll = normalizeItems(raw, "");

    // 元ネタは all に混ぜる（表示だけ）
    loadSeedLocalFromMetaphorsJS();
    const kvIds = new Set(kvAll.map(x => x.id));
    const seed = itemsSeedLocal.filter(x => !kvIds.has(x.id));

    itemsAll = kvAll.concat(seed);
  }

  async function refreshCurrentTab(){
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      if (activeTab === "pending") await loadPending();
      else if (activeTab === "public") await loadPublic();
      else await loadAll();
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`更新に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function refreshAllTabs(){
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      await Promise.all([loadPending(), loadPublic(), loadAll()]);
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`更新に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  // ✅ action後の再読込（同じ __ctrl で読み直す：自分でabortしない）
  async function reloadAllAfterAction(){
    await Promise.all([loadPending(), loadPublic(), loadAll()]);
    selectedIds = new Set();
    render();
  }

  function getSelectedIds(){ return Array.from(selectedIds); }

  // ✅ 承認（404対策で複数の候補を順に試す）
  async function approveIds(ids){
    if (!ids.length) return;

    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);

    try{
      // エンドポイント候補（Worker側の実装差を吸収）
      const paths = [
        "/api/admin/approve",
        "/api/admin/approve_pending",
        "/api/admin/approvePending",
        "/api/admin/publish",
        "/api/admin/approveOne",
      ];

      // body候補（ids / id / keys など差を吸収）
      const bodies = [
        { ids },
        { id: ids[0] },         // 1件用の可能性
        { keys: ids },
        { key: ids[0] },
        { items: ids },
      ];

      const r = await tryAdminPost(paths, bodies, __ctrl?.signal);

      console.log("approve used:", r.path, r.body, r.data);

      await reloadAllAfterAction();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`承認に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  // ✅ 却下（＝削除）：reject を試して、効かない/無効なら delete(pending) を必ず実行
  async function rejectIds(ids){
    if (!ids.length) return;

    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);

    try{
      // 1) reject（候補を試す）
      const rejectPaths = [
        "/api/admin/reject",
        "/api/admin/reject_pending",
        "/api/admin/rejectPending",
      ];
      const rejectBodies = [
        { ids },
        { id: ids[0] },
        { keys: ids },
        { key: ids[0] },
      ];

      let rejected = false;
      try{
        const r = await tryAdminPost(rejectPaths, rejectBodies);
        console.log("reject used:", r.path, r.body, r.data);
        rejected = true;
      } catch(e){
        // rejectが無い/効かないなら次へ
        console.warn("reject failed, fallback to delete:", e);
      }

      // 2) 最終的に消したい：delete(pending) を必ず実行（rejectが成功しても“残る”場合があるため）
      const delPaths = [
        "/api/admin/delete",
        "/api/admin/delete_pending",
        "/api/admin/deletePending",
      ];
      const delBodies = [
        { ids, scope:"pending" },
        { id: ids[0], scope:"pending" },
        { keys: ids, scope:"pending" },
        { key: ids[0], scope:"pending" },
      ];

      const d = await tryAdminPost(delPaths, delBodies);
      console.log("delete used:", d.path, d.body, d.data);

      await reloadAllAfterAction();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`却下（削除）に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  // ====== イベント ======
  btnSave.addEventListener("click", () => {
    saveSettings();
    alert("保存しました（このブラウザに記憶）");
  });

  btnHealth.addEventListener("click", doHealth);
  btnRefresh.addEventListener("click", refreshCurrentTab);
  btnRefreshAllTabs.addEventListener("click", refreshAllTabs);

  tabPending.addEventListener("click", () => setActiveTab("pending"));
  tabPublic.addEventListener("click",  () => setActiveTab("public"));
  tabAll.addEventListener("click",     () => setActiveTab("all"));

  chkAll.addEventListener("change", () => {
    const items = getActiveItems().filter(x => x.scope !== "seed-local");
    if (chkAll.checked) items.forEach(x => selectedIds.add(x.id));
    else items.forEach(x => selectedIds.delete(x.id));
    updateSelectionUI();
    listEl.querySelectorAll(".itemChk").forEach(chk => {
      const id = chk.getAttribute("data-id");
      chk.checked = selectedIds.has(id);
    });
  });

  btnBulkApprove.addEventListener("click", async () => {
    const ids = getSelectedIds();
    if (!ids.length) return alert("選択がありません");
    if (!confirm(`選択 ${ids.length}件 を承認しますか？`)) return;
    await approveIds(ids);
  });

  btnBulkReject.addEventListener("click", async () => {
    const ids = getSelectedIds();
    if (!ids.length) return alert("選択がありません");
    if (!confirm(`選択 ${ids.length}件 を却下（削除）しますか？（元に戻せません）`)) return;
    await rejectIds(ids);
  });

  // リスト内クリック（委譲）
  listEl.addEventListener("click", async (ev) => {
    const raw = ev.target;
    if (!raw) return;

    const el = (raw instanceof Element) ? raw.closest("button[data-act], input.itemChk") : null;
    if (!el) return;

    // checkbox
    if (el instanceof HTMLInputElement && el.classList.contains("itemChk")) {
      if (el.disabled) return;
      const id = el.getAttribute("data-id");
      if (!id) return;
      if (el.checked) selectedIds.add(id);
      else selectedIds.delete(id);
      updateSelectionUI();
      return;
    }

    // button
    if (el instanceof HTMLButtonElement) {
      const act = el.getAttribute("data-act");
      const id  = el.getAttribute("data-id");
      if (!act || !id) return;

      if (act === "approve") {
        if (!confirm("この1件を承認しますか？")) return;
        await approveIds([id]);
      } else if (act === "reject") {
        if (!confirm("この1件を却下（削除）しますか？（元に戻せません）")) return;
        await rejectIds([id]);
      }
    }
  });

  // ====== 初期化 ======
  loadSettings();
  setPill(pillHealth, "health: 未確認", null);
  setPill(pillAdmin,  "admin: 未確認", null);
  render();

})();
</script>

</body>
</html>
<!-- # END -->
