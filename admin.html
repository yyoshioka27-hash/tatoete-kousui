<!-- admin.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†ï¼ˆæ‰¿èªå¾…ã¡ / ä¸€èˆ¬å…¬é–‹ï¼‰</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --sub:#64748b;
      --line:rgba(15,23,42,.12);
      --card:#ffffff;
      --shadow:0 10px 24px rgba(2,6,23,.08);
      --blue:#2563eb;
      --red:#ef4444;
      --green:#16a34a;
      --btn:#0f172a;
      --btnText:#fff;
      --mutedBg:rgba(15,23,42,.04);
      --amber:#f59e0b;
    }
    body{
      margin:0;
      font-family: -apple-system, system-ui, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }
    h1{
      font-size: 28px;
      margin: 8px 0 14px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .field{
      display:flex;
      align-items:center;
      gap:8px;
      margin: 6px 0;
      flex-wrap:wrap;
    }
    label{
      font-size: 13px;
      color:var(--sub);
      width: 84px;
      flex: 0 0 auto;
    }
    input, select{
      border:1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      min-width: 220px;
      max-width: 100%;
    }
    input.wide{ min-width: 360px; }
    button{
      border:1px solid transparent;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      cursor:pointer;
      background: var(--btn);
      color: var(--btnText);
    }
    button.secondary{
      background:#fff;
      color:var(--text);
      border-color:var(--line);
    }
    button.blue{ background: var(--blue); }
    button.red{ background: var(--red); }
    button.amber{ background: var(--amber); color:#111827; }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .statusbar{
      margin-top: 10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 12px;
      background: var(--mutedBg);
      color: var(--sub);
      font-size: 13px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--sub);
      font-size: 12px;
    }
    .pill.ok{ color: var(--green); border-color: rgba(22,163,74,.35); }
    .pill.ng{ color: var(--red); border-color: rgba(239,68,68,.35); }
    .small{
      font-size: 12px;
      color: var(--sub);
    }
    .danger{
      color: var(--red);
      font-size: 13px;
      margin-top: 10px;
      white-space: pre-wrap;
    }

    /* tabs */
    .tabs{
      margin-top: 14px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tabbtn{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 13px;
      cursor:pointer;
    }
    .tabbtn.active{
      background: var(--text);
      color:#fff;
      border-color: var(--text);
    }

    .panel{
      margin-top: 12px;
      padding-top: 12px;
      border-top:1px solid var(--line);
    }

    .card{
      border:1px solid var(--line);
      border-radius: 14px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 12px 14px;
      margin: 10px 0;
    }
    .meta{
      font-size: 12px;
      color: var(--sub);
      margin-bottom: 8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .text{
      font-size: 16px;
      line-height: 1.5;
      margin: 0 0 10px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hint{
      font-size: 12px;
      color: var(--sub);
      margin-top: 10px;
      line-height: 1.6;
    }

    .top-actions{
      margin-left:auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 820px){
      .grid2{ grid-template-columns: 1fr; }
      input.wide{ min-width: 240px; }
    }

    .mutedBox{
      border:1px dashed rgba(15,23,42,.18);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(15,23,42,.02);
      color: var(--sub);
      font-size: 12px;
      line-height: 1.6;
      margin-top: 10px;
    }

    /* âœ… è¿½åŠ ï¼šä¸€æ‹¬æ“ä½œãƒãƒ¼ */
    .bulkbar{
      margin: 10px 0 8px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .bulkleft{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chk{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size: 13px;
      color: var(--sub);
      user-select:none;
      cursor:pointer;
    }
    .chk input{ min-width:auto; }
    .bulkright{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .countpill{
      display:inline-flex;
      align-items:center;
      padding: 5px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      font-size: 12px;
      color: var(--sub);
      background: var(--mutedBg);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ç®¡ç†ï¼ˆæ‰¿èªå¾…ã¡ / ä¸€èˆ¬å…¬é–‹ï¼‰</h1>

    <div class="row">
      <div style="flex:1; min-width: 520px;">
        <div class="field">
          <label for="apiBase">API_BASE:</label>
          <input id="apiBase" class="wide" type="text" value="https://ancient-union-4aa4tatoete-kousui-api.y-yoshioka27.workers.dev" />
        </div>
        <div class="field">
          <label for="adminKey">ADMIN_KEY:</label>
          <input id="adminKey" type="password" placeholder="ä¾‹: 2355" />
          <button class="blue" id="btnSave">ä¿å­˜</button>
        </div>
      </div>

      <div class="top-actions">
        <button class="secondary" id="btnHealth">health</button>
        <button class="secondary" id="btnRefresh">æ›´æ–°ï¼ˆè¡¨ç¤ºä¸­ã‚¿ãƒ–ï¼‰</button>
      </div>
    </div>

    <div class="statusbar">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <span class="pill" id="pillHealth">health: æœªç¢ºèª</span>
        <span class="pill" id="pillAdmin">admin: æœªç¢ºèª</span>
      </div>
      <div class="small">
        æ‰¿èªå¾…ã¡: <strong id="countPending">0</strong> ä»¶ / å…¬é–‹: <strong id="countPublic">0</strong> ä»¶
      </div>
    </div>

    <div class="danger" id="errBox" style="display:none;"></div>

    <!-- tabs -->
    <div class="tabs">
      <button class="tabbtn active" id="tabPending">ğŸ•’ æ‰¿èªå¾…ã¡</button>
      <button class="tabbtn" id="tabPublic">ğŸ“š ä¸€èˆ¬å…¬é–‹</button>
    </div>

    <!-- Pending Panel -->
    <div class="panel" id="panelPending">

      <!-- âœ… ä¸€æ‹¬æ“ä½œï¼ˆæ‰¿èªå¾…ã¡ï¼‰ -->
      <div class="bulkbar">
        <div class="bulkleft">
          <label class="chk"><input type="checkbox" id="chkAllPending"> å…¨é¸æŠ</label>
          <span class="countpill">é¸æŠ: <strong id="selPending">0</strong> ä»¶</span>
        </div>
        <div class="bulkright">
          <button class="blue" id="btnBulkApprove" disabled>ä¸€æ‹¬æ‰¿èª</button>
          <button class="red"  id="btnBulkReject"  disabled>ä¸€æ‹¬å´ä¸‹</button>
        </div>
      </div>

      <div id="pendingList">
        <p class="small">ã€Œæ›´æ–°ï¼ˆè¡¨ç¤ºä¸­ã‚¿ãƒ–ï¼‰ã€ã‚’æŠ¼ã™ã¨ã€æ‰¿èªå¾…ã¡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>

      <p class="hint">
        â€» å–å¾—: <code>/api/pending</code> / æ‰¿èª: <code>/api/approve</code> / å´ä¸‹: <code>/api/reject</code><br>
        â€» Worker ã®è¿”å´ãŒ <code>{ ok:true, items:[...] }</code> ã®å‰æã§ã™ã€‚
      </p>
    </div>

    <!-- Public Panel -->
    <div class="panel" id="panelPublic" style="display:none;">
      <div class="grid2">
        <div class="field">
          <label for="pubMode">mode:</label>
          <select id="pubMode">
            <option value="">å…¨ã¦</option>
            <option value="trivia">triviaï¼ˆé›‘å­¦ï¼‰</option>
            <option value="fun">funï¼ˆãŠç¬‘ã„ï¼‰</option>
          </select>
        </div>
        <div class="field">
          <label for="pubBucket">bucket:</label>
          <select id="pubBucket">
            <option value="">å…¨ã¦</option>
            <option value="0">0</option><option value="10">10</option><option value="20">20</option><option value="30">30</option>
            <option value="40">40</option><option value="50">50</option><option value="60">60</option><option value="70">70</option>
            <option value="80">80</option><option value="90">90</option><option value="100">100</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="pubLimit">limit:</label>
        <select id="pubLimit">
          <option value="50">50</option>
          <option value="200" selected>200</option>
          <option value="500">500</option>
        </select>
        <button class="secondary" id="btnPublicReload">å…¬é–‹ä¸€è¦§ã‚’å–å¾—</button>
      </div>

      <!-- âœ… ä¸€æ‹¬æ“ä½œï¼ˆå…¬é–‹ï¼‰ -->
      <div class="bulkbar">
        <div class="bulkleft">
          <label class="chk"><input type="checkbox" id="chkAllPublic"> å…¨é¸æŠ</label>
          <span class="countpill">é¸æŠ: <strong id="selPublic">0</strong> ä»¶</span>
        </div>
        <div class="bulkright">
          <button class="red" id="btnBulkDeletePublic" disabled>ä¸€æ‹¬å‰Šé™¤ï¼ˆå±é™ºï¼‰</button>
        </div>
      </div>

      <div class="mutedBox">
        âœ… ã€Œç®¡ç†å‰Šé™¤ã€ã¯ <strong>ã‚µãƒ¼ãƒï¼ˆKVï¼‰ã‹ã‚‰å‰Šé™¤</strong>ã—ã¾ã™ã€‚<br>
        â†’ ã¤ã¾ã‚Š <strong>å…¨å“¡ã®ä¸€èˆ¬å…¬é–‹ã‹ã‚‰æ¶ˆãˆã¾ã™</strong>ã€‚<br>
        â€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ï¼ˆå¾©æ´»ã¯å†æŠ•ç¨¿ãŒå¿…è¦ï¼‰ã€‚
      </div>

      <div id="publicList">
        <p class="small">ã€Œå…¬é–‹ä¸€è¦§ã‚’å–å¾—ã€ã‚’æŠ¼ã™ã¨ã€ä¸€èˆ¬å…¬é–‹ã®ãƒã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>

      <p class="hint">
        â€» ä¸€èˆ¬å…¬é–‹ã®å–å¾—ã¯ <code>/api/admin/list</code>ï¼ˆadmin onlyï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚<br>
        â€» å‰Šé™¤ã¯ <code>/api/admin/delete</code>ï¼ˆadmin onlyï¼‰ã§ã™ã€‚
      </p>
    </div>

  </div>

  <script>
    // ===========================
    // admin.html (pending + public manager)
    // ===========================

    const LS_API_BASE  = "tatoete_admin_api_base_v1";
    const LS_ADMIN_KEY = "tatoete_admin_key_v1";
    const LS_ACTIVE_TAB = "tatoete_admin_tab_v1"; // "pending" | "public"

    const $ = (id) => document.getElementById(id);

    function setErr(msg) {
      const box = $("errBox");
      if (!msg) {
        box.style.display = "none";
        box.textContent = "";
        return;
      }
      box.style.display = "block";
      box.textContent = String(msg);
    }

    function setPill(el, text, ok=null) {
      el.textContent = text;
      el.classList.remove("ok","ng");
      if (ok === true) el.classList.add("ok");
      if (ok === false) el.classList.add("ng");
    }

    function loadSaved() {
      const api = localStorage.getItem(LS_API_BASE);
      const key = localStorage.getItem(LS_ADMIN_KEY);
      const tab = localStorage.getItem(LS_ACTIVE_TAB);
      if (api) $("apiBase").value = api;
      if (key) $("adminKey").value = key;
      if (tab === "public") setActiveTab("public");
      else setActiveTab("pending");
    }

    function saveInputs() {
      localStorage.setItem(LS_API_BASE, $("apiBase").value.trim());
      localStorage.setItem(LS_ADMIN_KEY, ($("adminKey").value || "").trim());
    }

    function getApiBase() {
      return $("apiBase").value.trim().replace(/\/+$/,"");
    }

    // â˜…è¶…é‡è¦ï¼šADMIN_KEYãŒç©ºãªã‚‰promptã§èãâ†’å…¥åŠ›æ¬„ï¼†localStorageã¸åæ˜ 
    function getAdminKey({ forcePrompt = false } = {}) {
      let k = ($("adminKey").value || "").trim();

      if (forcePrompt || !k) {
        const p = (prompt("ADMIN_KEY ã‚’å…¥ã‚Œã¦") || "").trim();
        if (p) {
          $("adminKey").value = p;
          k = p;
          localStorage.setItem(LS_ADMIN_KEY, k);
        }
      }
      return k;
    }

    function fmtTime(ms) {
      const d = new Date(Number(ms || 0));
      if (Number.isNaN(d.getTime())) return "";
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${yy}/${mm}/${dd} ${hh}:${mi}:${ss}`;
    }

    async function apiGet(path, admin=false) {
      const url = `${getApiBase()}${path}`;
      const headers = {};

      if (admin) {
        const k = getAdminKey();
        if (!k) throw new Error("ADMIN_KEY ãŒç©ºã§ã™ï¼ˆå…¥åŠ›ã¾ãŸã¯ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰");
        headers["x-admin-key"] = k;
      }

      const res = await fetch(url, { headers });
      const data = await res.json().catch(() => null);
      return { res, data };
    }

    async function apiPost(path, body, admin=false) {
      const url = `${getApiBase()}${path}`;
      const headers = { "Content-Type":"application/json" };

      if (admin) {
        const k = getAdminKey();
        if (!k) throw new Error("ADMIN_KEY ãŒç©ºã§ã™ï¼ˆå…¥åŠ›ã¾ãŸã¯ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰");
        headers["x-admin-key"] = k;
      }

      const res = await fetch(url, {
        method: "POST",
        headers,
        body: JSON.stringify(body || {})
      });
      const data = await res.json().catch(() => null);
      return { res, data };
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---------------------------
    // Tabs
    // ---------------------------
    function setActiveTab(tab){
      const isPending = (tab === "pending");
      $("panelPending").style.display = isPending ? "block" : "none";
      $("panelPublic").style.display  = isPending ? "none"  : "block";
      $("tabPending").classList.toggle("active", isPending);
      $("tabPublic").classList.toggle("active", !isPending);
      localStorage.setItem(LS_ACTIVE_TAB, tab);
    }

    $("tabPending").addEventListener("click", () => setActiveTab("pending"));
    $("tabPublic").addEventListener("click", () => setActiveTab("public"));

    function getCurrentTab(){
      return localStorage.getItem(LS_ACTIVE_TAB) === "public" ? "public" : "pending";
    }

    // ---------------------------
    // âœ… Bulk helpers
    // ---------------------------
    function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

    function updatePendingSelectionUI(){
      const checks = qsa("input[data-pick='pending']");
      const checked = checks.filter(c => c.checked);
      $("selPending").textContent = String(checked.length);
      $("btnBulkApprove").disabled = checked.length === 0;
      $("btnBulkReject").disabled  = checked.length === 0;

      const all = checks.length > 0 && checked.length === checks.length;
      $("chkAllPending").checked = all;
    }

    function updatePublicSelectionUI(){
      const checks = qsa("input[data-pick='public']");
      const checked = checks.filter(c => c.checked);
      $("selPublic").textContent = String(checked.length);
      $("btnBulkDeletePublic").disabled = checked.length === 0;

      const all = checks.length > 0 && checked.length === checks.length;
      $("chkAllPublic").checked = all;
    }

    async function bulkRun(ids, fn){
      for (let i=0; i<ids.length; i++){
        await fn(ids[i], i, ids.length);
      }
    }

    // ---------------------------
    // Pending render
    // ---------------------------
    function renderPending(items) {
      const list = $("pendingList");
      list.innerHTML = "";

      const arr = Array.isArray(items) ? items : [];
      $("countPending").textContent = String(arr.length);

      // âœ… ä¸€æ‹¬UIåˆæœŸåŒ–
      $("chkAllPending").checked = false;
      $("selPending").textContent = "0";
      $("btnBulkApprove").disabled = true;
      $("btnBulkReject").disabled  = true;

      if (arr.length === 0) {
        list.innerHTML = `<p class="small">æ‰¿èªå¾…ã¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
        return;
      }

      for (const it of arr) {
        const id = it?.id || "";
        const mode = it?.mode ?? "";
        const bucket = it?.bucket ?? "";
        const from = it?.from ? `from: ${it.from}` : "";
        const at = it?.createdAt ? fmtTime(it.createdAt) : "";
        const text = it?.text ?? "";

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="meta">
            <label class="chk" style="color:var(--text);">
              <input type="checkbox" data-pick="pending" data-id="${escapeHtml(id)}">
              é¸æŠ
            </label>
            <span>ID: <code>${escapeHtml(id)}</code></span>
            <span>mode: <code>${escapeHtml(mode)}</code></span>
            <span>bucket: <code>${escapeHtml(bucket)}</code></span>
            ${from ? `<span>${escapeHtml(from)}</span>` : ""}
            ${at ? `<span>at: ${escapeHtml(at)}</span>` : ""}
          </div>

          <p class="text">${escapeHtml(text)}</p>

          <div class="actions">
            <button class="blue" data-act="approve" data-id="${escapeHtml(id)}">æ‰¿èª</button>
            <button class="red"  data-act="reject"  data-id="${escapeHtml(id)}">å´ä¸‹</button>
          </div>
        `;

        list.appendChild(card);
      }

      // ãƒã‚§ãƒƒã‚¯UI
      qsa("input[data-pick='pending']", list).forEach(chk => {
        chk.addEventListener("change", updatePendingSelectionUI);
      });
      updatePendingSelectionUI();

      // event delegation
      list.querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const act = btn.getAttribute("data-act");
          const id  = btn.getAttribute("data-id");
          if (!id) return;

          btn.disabled = true;
          setErr("");

          try {
            if (act === "approve") {
              const { res, data } = await apiPost("/api/approve", { id }, true);
              if (!res.ok || !data?.ok) throw new Error(data?.error || `approve failed ${res.status}`);
            } else if (act === "reject") {
              const { res, data } = await apiPost("/api/reject", { id }, true);
              if (!res.ok || !data?.ok) throw new Error(data?.error || `reject failed ${res.status}`);
            }
            await fetchPending(); // refresh
          } catch (e) {
            setErr(e?.message || String(e));
          } finally {
            btn.disabled = false;
          }
        });
      });
    }

    async function fetchPending() {
      setErr("");
      try {
        const { res, data } = await apiGet("/api/pending", true);
        if (!res.ok || !data?.ok) {
          setPill($("pillAdmin"), "admin: NG", false);
          throw new Error(data?.error || `pending failed ${res.status}`);
        }
        setPill($("pillAdmin"), "admin: OK", true);
        renderPending(data.items);
      } catch (e) {
        setPill($("pillAdmin"), "admin: NG", false);
        setErr(e?.message || String(e));
        renderPending([]);
      }
    }

    // âœ… Pending bulk
    $("chkAllPending").addEventListener("change", () => {
      const on = $("chkAllPending").checked;
      qsa("input[data-pick='pending']").forEach(c => c.checked = on);
      updatePendingSelectionUI();
    });

    $("btnBulkApprove").addEventListener("click", async () => {
      const ids = qsa("input[data-pick='pending']:checked").map(c => c.getAttribute("data-id")).filter(Boolean);
      if (!ids.length) return;

      const ok = confirm(`é¸æŠã—ãŸ ${ids.length} ä»¶ã‚’ä¸€æ‹¬æ‰¿èªã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      $("btnBulkApprove").disabled = true;
      $("btnBulkReject").disabled  = true;

      try{
        await bulkRun(ids, async (id) => {
          const { res, data } = await apiPost("/api/approve", { id }, true);
          if (!res.ok || !data?.ok) throw new Error(data?.error || `approve failed ${res.status}`);
        });
        await fetchPending();
      }catch(e){
        setErr(e?.message || String(e));
        await fetchPending();
      }
    });

    $("btnBulkReject").addEventListener("click", async () => {
      const ids = qsa("input[data-pick='pending']:checked").map(c => c.getAttribute("data-id")).filter(Boolean);
      if (!ids.length) return;

      const ok = confirm(`é¸æŠã—ãŸ ${ids.length} ä»¶ã‚’ä¸€æ‹¬å´ä¸‹ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      $("btnBulkApprove").disabled = true;
      $("btnBulkReject").disabled  = true;

      try{
        await bulkRun(ids, async (id) => {
          const { res, data } = await apiPost("/api/reject", { id }, true);
          if (!res.ok || !data?.ok) throw new Error(data?.error || `reject failed ${res.status}`);
        });
        await fetchPending();
      }catch(e){
        setErr(e?.message || String(e));
        await fetchPending();
      }
    });

    // ---------------------------
    // Public render (admin list + admin delete)
    // ---------------------------
    function renderPublic(items) {
      const list = $("publicList");
      list.innerHTML = "";

      const arr = Array.isArray(items) ? items : [];
      $("countPublic").textContent = String(arr.length);

      // âœ… ä¸€æ‹¬UIåˆæœŸåŒ–
      $("chkAllPublic").checked = false;
      $("selPublic").textContent = "0";
      $("btnBulkDeletePublic").disabled = true;

      if (arr.length === 0) {
        list.innerHTML = `<p class="small">ä¸€èˆ¬å…¬é–‹ã®ãƒã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆã¾ãŸã¯æ¡ä»¶ã«è©²å½“ãªã—ï¼‰ã€‚</p>`;
        return;
      }

      for (const it of arr) {
        const id = it?.id || "";
        const mode = it?.mode ?? "";
        const bucket = it?.bucket ?? "";
        const at = it?.createdAt ? fmtTime(it.createdAt) : "";
        const text = it?.text ?? "";

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="meta">
            <label class="chk" style="color:var(--text);">
              <input type="checkbox" data-pick="public" data-id="${escapeHtml(id)}">
              é¸æŠ
            </label>
            <span>ID: <code>${escapeHtml(id)}</code></span>
            <span>mode: <code>${escapeHtml(mode)}</code></span>
            <span>bucket: <code>${escapeHtml(bucket)}</code></span>
            ${at ? `<span>at: ${escapeHtml(at)}</span>` : ""}
          </div>

          <p class="text">${escapeHtml(text)}</p>

          <div class="actions">
            <button class="red" data-act="deletePublic" data-id="${escapeHtml(id)}">ç®¡ç†å‰Šé™¤ï¼ˆå…¨å“¡ã‹ã‚‰æ¶ˆãˆã‚‹ï¼‰</button>
          </div>
        `;

        list.appendChild(card);
      }

      // ãƒã‚§ãƒƒã‚¯UI
      qsa("input[data-pick='public']", list).forEach(chk => {
        chk.addEventListener("change", updatePublicSelectionUI);
      });
      updatePublicSelectionUI();

      list.querySelectorAll("button[data-act='deletePublic']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!id) return;

          const ok = confirm(
            "ã“ã®ãƒã‚¿ã‚’ã‚µãƒ¼ãƒã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚\nå…¨å“¡ã®ä¸€èˆ¬å…¬é–‹ã‹ã‚‰æ¶ˆãˆã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
          );
          if (!ok) return;

          btn.disabled = true;
          setErr("");

          try {
            const { res, data } = await apiPost("/api/admin/delete", { id }, true);
            if (!res.ok || !data?.ok) throw new Error(data?.error || `delete failed ${res.status}`);
            await fetchPublic(); // refresh
          } catch (e) {
            setErr(e?.message || String(e));
          } finally {
            btn.disabled = false;
          }
        });
      });
    }

    async function fetchPublic() {
      setErr("");

      const mode = ($("pubMode").value || "").trim();
      const bucket = ($("pubBucket").value || "").trim();
      const limit = Number(($("pubLimit").value || "200").trim());

      const qs = new URLSearchParams();
      if (mode) qs.set("mode", mode);
      if (bucket) qs.set("bucket", bucket);
      qs.set("limit", String(Math.max(1, Math.min(500, Number.isFinite(limit) ? limit : 200))));

      try {
        const { res, data } = await apiGet(`/api/admin/list?${qs.toString()}`, true);
        if (!res.ok || !data?.ok) {
          setPill($("pillAdmin"), "admin: NG", false);
          throw new Error(data?.error || `admin/list failed ${res.status}`);
        }
        setPill($("pillAdmin"), "admin: OK", true);
        renderPublic(data.items);
      } catch (e) {
        setPill($("pillAdmin"), "admin: NG", false);
        setErr(e?.message || String(e));
        renderPublic([]);
      }
    }

    // âœ… Public bulk
    $("chkAllPublic").addEventListener("change", () => {
      const on = $("chkAllPublic").checked;
      qsa("input[data-pick='public']").forEach(c => c.checked = on);
      updatePublicSelectionUI();
    });

    $("btnBulkDeletePublic").addEventListener("click", async () => {
      const ids = qsa("input[data-pick='public']:checked").map(c => c.getAttribute("data-id")).filter(Boolean);
      if (!ids.length) return;

      const ok1 = confirm(`é¸æŠã—ãŸ ${ids.length} ä»¶ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã™ã€‚\nï¼ˆå…¨å“¡ã‹ã‚‰æ¶ˆãˆã¾ã™ï¼‰\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
      if (!ok1) return;

      const ok2 = prompt("èª¤æ“ä½œé˜²æ­¢ï¼šDELETE ã¨å…¥åŠ›ã™ã‚‹ã¨å®Ÿè¡Œã—ã¾ã™");
      if ((ok2 || "").trim().toUpperCase() !== "DELETE") return;

      $("btnBulkDeletePublic").disabled = true;

      try{
        await bulkRun(ids, async (id) => {
          const { res, data } = await apiPost("/api/admin/delete", { id }, true);
          if (!res.ok || !data?.ok) throw new Error(data?.error || `delete failed ${res.status}`);
        });
        await fetchPublic();
      }catch(e){
        setErr(e?.message || String(e));
        await fetchPublic();
      }
    });

    // ---------------------------
    // Health
    // ---------------------------
    async function checkHealth() {
      setErr("");
      try {
        const { res, data } = await apiGet("/api/health", false);
        if (!res.ok || !data?.ok) {
          setPill($("pillHealth"), "health: NG", false);
          throw new Error(data?.error || `health failed ${res.status}`);
        }
        setPill($("pillHealth"), `health: OK (kv:${data.kv ? "true":"false"})`, true);
        return true;
      } catch (e) {
        setPill($("pillHealth"), "health: NG", false);
        setErr(e?.message || String(e));
        return false;
      }
    }

    // ---------------------------
    // Bind
    // ---------------------------
    $("btnSave").addEventListener("click", () => {
      saveInputs();
      setErr("");
    });

    $("btnHealth").addEventListener("click", async () => {
      await checkHealth();
    });

    $("btnRefresh").addEventListener("click", async () => {
      const tab = getCurrentTab();
      if (tab === "public") await fetchPublic();
      else await fetchPending();
    });

    $("btnPublicReload").addEventListener("click", async () => {
      await fetchPublic();
    });

    // init
    loadSaved();
    checkHealth(); // healthã ã‘å…ˆã«

    // # END
  </script>

</body>
</html>
