<!-- admin.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>管理（承認待ち）</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --sub:#64748b;
      --line:rgba(15,23,42,.12);
      --card:#ffffff;
      --shadow:0 10px 24px rgba(2,6,23,.08);
      --blue:#2563eb;
      --red:#ef4444;
      --green:#16a34a;
    }
    body{ font-family: system-ui, -apple-system; margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:840px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:var(--shadow); margin:12px 0; }
    input{ padding:10px 12px; border:1px solid var(--line); border-radius:12px; width:100%; box-sizing:border-box; }
    button{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#0f172a; color:#fff; cursor:pointer; }
    button.sub{ background:var(--blue); }
    button.ok{ background:var(--green); }
    button.ng{ background:var(--red); }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted{ color:var(--sub); font-size:13px; }
    .item{ border-top:1px dashed var(--line); padding-top:10px; margin-top:10px; }
    .item:first-child{ border-top:none; padding-top:0; margin-top:0; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:6px 0 14px;">承認待ち 管理</h2>

    <div class="card">
      <div class="row">
        <div style="flex:1; min-width:260px;">
          <div class="muted">ADMIN_KEY</div>
          <input id="key" placeholder="x-admin-key を入力" />
        </div>
        <div>
          <div class="muted">API</div>
          <input id="api" class="mono" value="https://ancient-union-4aa4tatoete-kousui-api.y-yoshioka27.workers.dev" />
        </div>
        <div style="padding-top:22px;">
          <button id="load" class="sub">一覧取得</button>
        </div>
      </div>
      <div id="msg" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div style="font-weight:700;">承認待ち一覧</div>
      <div id="list" class="muted" style="margin-top:8px;">未取得</div>
    </div>
  </div>

<script>
  function esc(s){ return String(s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  function $(id){ return document.getElementById(id); }

  async function adminGET(path){
    const API = $("api").value.trim();
    const key = $("key").value.trim();
    const res = await fetch(`${API}${path}`, {
      method:"GET",
      headers: { "x-admin-key": key }
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok || !data?.ok) throw new Error(data?.error || `GET failed ${res.status}`);
    return data;
  }

  async function adminPOST(path, body){
    const API = $("api").value.trim();
    const key = $("key").value.trim();
    const res = await fetch(`${API}${path}`, {
      method:"POST",
      headers: { "Content-Type":"application/json", "x-admin-key": key },
      body: JSON.stringify(body||{})
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok || !data?.ok) throw new Error(data?.error || `POST failed ${res.status}`);
    return data;
  }

  async function load(){
    $("msg").textContent = "読み込み中…";
    try{
      const data = await adminGET("/api/admin/pending");
      render(data.items || []);
      $("msg").textContent = `取得OK（${(data.items||[]).length}件）`;
    }catch(e){
      $("msg").textContent = `エラー: ${e.message}`;
    }
  }

  function render(items){
    if(items.length===0){
      $("list").innerHTML = "承認待ちは0件";
      return;
    }
    $("list").innerHTML = items.map(x=>{
      return `
        <div class="item">
          <div style="font-weight:700; color:#0f172a;">${esc(x.text)}</div>
          <div class="muted">mode=${esc(x.mode)} / bucket=${esc(x.bucket)} / pen=${esc(x.penName||"")}</div>
          <div class="row" style="margin-top:8px;">
            <button class="ok" data-approve="${esc(x.id)}">承認</button>
            <button class="ng" data-reject="${esc(x.id)}">却下</button>
            <span class="muted mono">${esc(x.id)}</span>
          </div>
        </div>
      `;
    }).join("");

    document.querySelectorAll("[data-approve]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        btn.disabled = true;
        try{
          await adminPOST("/api/admin/approve", { id: btn.getAttribute("data-approve") });
          await load();
        }catch(e){
          $("msg").textContent = `エラー: ${e.message}`;
        }finally{
          btn.disabled = false;
        }
      });
    });

    document.querySelectorAll("[data-reject]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        btn.disabled = true;
        try{
          await adminPOST("/api/admin/reject", { id: btn.getAttribute("data-reject") });
          await load();
        }catch(e){
          $("msg").textContent = `エラー: ${e.message}`;
        }finally{
          btn.disabled = false;
        }
      });
    });
  }

  $("load").addEventListener("click", load);
</script>
</body>
</html>

<!-- END -->
