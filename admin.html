<!-- admin.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <title>管理（承認待ち／一般公開）</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --sub:#64748b;
      --line:rgba(15,23,42,.12);
      --card:#ffffff;
      --shadow:0 10px 24px rgba(2,6,23,.08);
      --blue:#2563eb;
      --red:#ef4444;
      --green:#16a34a;
      --btn:#0f172a;
      --btnText:#fff;
      --mutedBg:rgba(15,23,42,.04);
      --radius:16px;
    }
    body{ margin:0; padding:18px; font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
    .container{ max-width:980px; margin:0 auto; }
    h1{ margin:6px 0 16px; font-size:24px; letter-spacing:-.2px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin:12px 0; }
    .muted{ color:var(--sub); font-size:12px; }
    label{ font-size:12px; color:var(--sub); display:block; margin-bottom:6px; }
    input, select{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); min-width:280px; font-size:14px; background:#fff; outline:none; }
    input:focus, select:focus{ border-color: rgba(37,99,235,0.55); box-shadow: 0 0 0 4px rgba(37,99,235,0.12); }
    button{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer; font-size:14px; user-select:none; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .btnPrimary{ background:var(--blue); color:#fff; border-color:rgba(37,99,235,0.55); font-weight:800; }
    .btnDanger{ background:var(--red); color:#fff; border-color:rgba(239,68,68,.6); font-weight:800; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--mutedBg); font-size:12px; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tab{ padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; font-weight:800; }
    .tab.active{ background:var(--btn); color:var(--btnText); border-color:rgba(15,23,42,.35); }
    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; padding:10px 0 0; border-top:1px solid rgba(15,23,42,.08); margin-top:10px; }
    .list{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .item{ border:1px solid rgba(15,23,42,.10); border-radius:14px; padding:12px; background:rgba(255,255,255,.9); }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .itemText{ font-size:15px; line-height:1.55; font-weight:700; margin:8px 0; white-space:pre-wrap; }
    .itemMeta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid rgba(15,23,42,.12); background:rgba(255,255,255,.75); font-size:12px; color:var(--sub); font-weight:800; }
    .badgePublic{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.07); color: #166534; }
    .badgePending{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.07); color: #991b1b; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chk{ transform:translateY(1px); }
    .right{ margin-left:auto; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .smallBtn{ padding:8px 10px; border-radius:10px; font-size:13px; }
    .btnGhost{ background:#fff; }
    .btnOk{ background:var(--green); color:#fff; border-color: rgba(22,163,74,.6); font-weight:800; }
    .divider{ height:1px; background:rgba(15,23,42,.08); margin:10px 0; }
    .warn{ color:#b45309; font-weight:800; }
    details > summary{ cursor:pointer; user-select:none; color:var(--sub); font-size:12px; }
    pre{ margin:8px 0 0; padding:10px; border-radius:12px; background:rgba(15,23,42,.04); overflow:auto; }
  </style>
</head>

<body>
<div class="container">
  <h1>管理（承認待ち／一般公開）</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>API_BASE</label>
        <input id="apiBase" class="mono" />
      </div>
      <div>
        <label>ADMIN_KEY</label>
        <input id="adminKey" class="mono" placeholder="例：2355" />
      </div>

      <div class="row" style="gap:8px; align-items:flex-end;">
        <button id="btnSave" class="btnPrimary">保存</button>
        <button id="btnHealth">health</button>
        <button id="btnRefresh">更新（表示中タブ）</button>
        <button id="btnRefreshAllTabs">更新（全タブ）</button>
        <button id="btnImportSeed">初期ネタを取り込み</button>
      </div>

      <div class="right row" style="gap:8px;">
        <span class="pill" id="pillHealth">health: 未確認</span>
        <span class="pill" id="pillAdmin">admin: 未確認</span>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ※ 管理操作は <span class="mono">x-admin-key</span> ヘッダで送ります。<span class="mono">ADMIN_KEY</span> が間違うと 403 になります。
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="tabs">
        <button id="tabPending" class="tab active">承認待ち</button>
        <button id="tabPublic" class="tab">一般公開</button>
        <button id="tabAll" class="tab">全ネタ（public+pending）</button>
      </div>
      <div class="muted" id="counts">承認待ち: 0件 / 公開: 0件 / 全: 0件</div>
    </div>

    <div class="toolbar">
      <div class="row" style="gap:12px;">
        <label style="margin:0; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="chkAll" class="chk" />
          全選択
        </label>
        <span class="pill" id="selCount">選択: 0件</span>
        <span class="pill" id="pillBusy" style="display:none;">通信中…</span>
      </div>
      <div class="actions">
        <button id="btnBulkApprove" class="btnOk">一括承認</button>
        <button id="btnBulkReject" class="btnDanger">一括却下</button>
        <button id="btnBulkDelete" class="btnDanger" style="display:none;">選択を削除</button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ※ 承認待ち: <span class="mono">/api/admin/pending</span> / 承認: <span class="mono">/api/admin/approve</span> / 却下: <span class="mono">/api/admin/reject</span><br/>
      ※ 公開: <span class="mono">/api/admin/list</span> / 削除: <span class="mono">/api/admin/delete</span><br/>
      ※ 全ネタ: <span class="mono">/api/admin/all?scope=both</span>（表示のみ） / 削除: <span class="mono">/api/admin/delete</span>
    </div>

    <div class="list" id="list"></div>
  </div>

  <div class="muted" style="text-align:center; margin:14px 0 8px;">
    admin.html（堅牢版） / # END
  </div>
</div>

<script>
(() => {
  const DEFAULT_API_BASE = "https://ancient-union-4aa4tatoete-kousui-api.y-yoshioka27.workers.dev";
  const LS_API = "tatoete_admin_api_base";
  const LS_KEY = "tatoete_admin_key";

  const $ = (id) => document.getElementById(id);

  const elApiBase = $("apiBase");
  const elAdminKey = $("adminKey");
  const pillHealth = $("pillHealth");
  const pillAdmin  = $("pillAdmin");
  const countsEl   = $("counts");
  const listEl     = $("list");

  const tabPending = $("tabPending");
  const tabPublic  = $("tabPublic");
  const tabAll     = $("tabAll");

  const chkAll     = $("chkAll");
  const selCount   = $("selCount");
  const pillBusy   = $("pillBusy");

  const btnSave    = $("btnSave");
  const btnHealth  = $("btnHealth");
  const btnRefresh = $("btnRefresh");
  const btnRefreshAllTabs = $("btnRefreshAllTabs");
  const btnImportSeed = $("btnImportSeed");

  const btnBulkApprove = $("btnBulkApprove");
  const btnBulkReject  = $("btnBulkReject");
  const btnBulkDelete  = $("btnBulkDelete");

  let activeTab = "pending"; // pending | public | all
  let itemsPending = [];
  let itemsPublic  = [];
  let itemsAll     = [];
  let selectedIds = new Set();

  // in-flight制御（多重更新防止）
  let __busy = false;
  let __ctrl = null;

  function apiBase(){
    return String(elApiBase.value || "").trim().replace(/\/+$/,"");
  }
  function adminKey(){
    return String(elAdminKey.value || "").trim();
  }

  function setPill(el, text, ok=null){
    el.textContent = text;
    el.style.borderColor = ok===true ? "rgba(22,163,74,.45)"
                      : ok===false ? "rgba(239,68,68,.45)"
                      : "rgba(15,23,42,.20)";
  }

  function setBusy(on){
    __busy = !!on;
    pillBusy.style.display = __busy ? "inline-flex" : "none";
    // 重要：操作ボタンをまとめて止める（固まり防止）
    const dis = __busy;
    [btnSave, btnHealth, btnRefresh, btnRefreshAllTabs, btnImportSeed,
     tabPending, tabPublic, tabAll,
     btnBulkApprove, btnBulkReject, btnBulkDelete].forEach(b => { try{ b.disabled = dis; }catch{} });
  }

  function abortInFlight(){
    try{ if (__ctrl) __ctrl.abort(); }catch{}
    __ctrl = null;
    __busy = false;
    setBusy(false);
  }

  async function fetchJSON(path, { method="GET", body=null, admin=false, signal=null } = {}){
    const base = apiBase();
    if (!base) throw new Error("API_BASE が空です");

    const url = base + path;
    const headers = { "Content-Type":"application/json" };
    if (admin){
      const k = adminKey();
      if (!k) throw new Error("ADMIN_KEY が空です");
      headers["x-admin-key"] = k;
    }

    const res = await fetch(url, {
      method,
      headers,
      body: body ? JSON.stringify(body) : null,
      signal
    });

    const data = await res.json().catch(()=>null);

    if (!res.ok || !data?.ok){
      const msg = data?.error || `HTTP ${res.status}`;
      const e = new Error(msg);
      e.status = res.status;
      e.data = data;
      throw e;
    }
    return data;
  }

  function formatTs(ts){
    const n = Number(ts);
    if (!Number.isFinite(n) || n <= 0) return "";
    const d = new Date(n);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  function safeText(v){
    return (v == null) ? "" : String(v);
  }

  function normalizeItems(arr, scope){
    // 期待：{ id, text, bucket, mode, likes, penName, createdAt, ... }
    // scope: "pending" | "public" | "both"
    return (Array.isArray(arr) ? arr : []).map(x => ({
      id: safeText(x.id ?? x.key ?? x._id ?? ""),
      text: safeText(x.text ?? x.metaphor ?? x.value ?? ""),
      bucket: (x.bucket ?? x.b ?? null),
      mode: safeText(x.mode ?? x.m ?? ""),
      likes: (x.likes ?? x.like ?? 0),
      penName: safeText(x.penName ?? x.pen ?? x.author ?? ""),
      createdAt: (x.createdAt ?? x.ts ?? x.time ?? 0),
      scope: scope || safeText(x.scope ?? "")
    })).filter(x => x.id);
  }

  function updateCounts(){
    countsEl.textContent = `承認待ち: ${itemsPending.length}件 / 公開: ${itemsPublic.length}件 / 全: ${itemsAll.length}件`;
  }

  function updateSelectionUI(){
    selCount.textContent = `選択: ${selectedIds.size}件`;
    // 全選択の見た目
    const current = getActiveItems();
    const allIds = current.map(x => x.id);
    const allSelected = allIds.length > 0 && allIds.every(id => selectedIds.has(id));
    chkAll.checked = allSelected;
    chkAll.indeterminate = (!allSelected && selectedIds.size > 0);

    // タブに応じて一括ボタンの見せ方
    if (activeTab === "pending"){
      btnBulkApprove.style.display = "";
      btnBulkReject.style.display  = "";
      btnBulkDelete.style.display  = "none";
    } else {
      btnBulkApprove.style.display = "none";
      btnBulkReject.style.display  = "none";
      btnBulkDelete.style.display  = "";
    }
  }

  function setActiveTab(tab){
    activeTab = tab;
    tabPending.classList.toggle("active", tab==="pending");
    tabPublic.classList.toggle("active",  tab==="public");
    tabAll.classList.toggle("active",     tab==="all");
    selectedIds = new Set(); // タブ切替で選択はリセット（事故防止）
    render();
  }

  function getActiveItems(){
    if (activeTab === "pending") return itemsPending;
    if (activeTab === "public")  return itemsPublic;
    return itemsAll;
  }

  function render(){
    updateCounts();

    const items = getActiveItems();
    updateSelectionUI();

    if (!items.length){
      listEl.innerHTML = `<div class="muted">（データがありません）</div>`;
      return;
    }

    const html = items.map(item => {
      const checked = selectedIds.has(item.id) ? "checked" : "";
      const isPending = (activeTab === "pending") || (item.scope === "pending");
      const isPublic  = (activeTab === "public")  || (item.scope === "public");

      const badgeScope = (activeTab === "all")
        ? (isPending
            ? `<span class="badge badgePending">pending</span>`
            : `<span class="badge badgePublic">public</span>`)
        : (activeTab === "pending"
            ? `<span class="badge badgePending">pending</span>`
            : `<span class="badge badgePublic">public</span>`);

      const metaParts = [];
      if (item.mode) metaParts.push(`<span class="badge">mode: ${escapeHtml(item.mode)}</span>`);
      if (item.bucket != null && item.bucket !== "") metaParts.push(`<span class="badge">bucket: ${escapeHtml(item.bucket)}</span>`);
      metaParts.push(`<span class="badge">likes: ${escapeHtml(item.likes)}</span>`);
      if (item.penName) metaParts.push(`<span class="badge">pen: ${escapeHtml(item.penName)}</span>`);
      const ts = formatTs(item.createdAt);
      if (ts) metaParts.push(`<span class="badge">${escapeHtml(ts)}</span>`);

      const text = item.text || "";
      const tooLong = text.length > 240;
      const textHtml = tooLong
        ? `
          <details>
            <summary>本文を展開（${text.length}文字）</summary>
            <div class="itemText">${escapeHtml(text)}</div>
          </details>
        `
        : `<div class="itemText">${escapeHtml(text)}</div>`;

      const perActions = [];

// ★ 承認待ちでも delete を使う（後退防止）
if (activeTab === "pending"){
  perActions.push(
    `<button class="smallBtn btnDanger" data-act="delete" data-id="${escapeAttr(item.id)}">削除</button>`
  );
} else {
  perActions.push(
    `<button class="smallBtn btnDanger" data-act="delete" data-id="${escapeAttr(item.id)}">削除</button>`
  );
}


      // all タブは表示のみが基本だが、削除は許可（要望）
      if (activeTab === "all"){
        perActions.length = 0;
        perActions.push(`<button class="smallBtn btnDanger" data-act="delete" data-id="${escapeAttr(item.id)}">削除</button>`);
      }

      return `
        <div class="item" data-item="${escapeAttr(item.id)}">
          <div class="itemTop">
            <div class="itemMeta">
              <label style="margin:0; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" class="chk itemChk" data-id="${escapeAttr(item.id)}" ${checked} />
                <span class="muted mono">${escapeHtml(item.id)}</span>
              </label>
              ${badgeScope}
              ${metaParts.join("")}
            </div>
            <div class="actions">
              ${perActions.join("")}
            </div>
          </div>
          ${textHtml}
        </div>
      `;
    }).join("");

    listEl.innerHTML = html;
  }

  // XSS対策（表示だけでも守る）
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll("`","&#096;");
  }

  function saveSettings(){
    localStorage.setItem(LS_API, apiBase() || DEFAULT_API_BASE);
    localStorage.setItem(LS_KEY, adminKey() || "");
  }

  function loadSettings(){
    const a = localStorage.getItem(LS_API) || DEFAULT_API_BASE;
    const k = localStorage.getItem(LS_KEY) || "";
    elApiBase.value = a;
    elAdminKey.value = k;
  }

  async function doHealth(){
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      const data = await fetchJSON("/api/health", { signal: __ctrl.signal });
      // 例：{ ok:true, status:"ok", kv:true, hofThreshold:20 }
      const kv = (data.kv === true) ? "kv:OK" : "kv:?" ;
      setPill(pillHealth, `health: OK (${kv})`, true);

      // admin確認は「軽く pending を叩いて 403/OK を判定」
      try{
        await fetchJSON("/api/admin/pending?limit=1", { admin:true, signal: __ctrl.signal });
        setPill(pillAdmin, "admin: OK", true);
      } catch(e){
        if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
        else setPill(pillAdmin, `admin: NG（${e.message}）`, false);
      }
    } catch(e){
      setPill(pillHealth, `health: NG（${e.message}）`, false);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function loadPending(){
    const data = await fetchJSON("/api/admin/pending", { admin:true, signal: __ctrl.signal });
    // 期待：{ ok:true, items:[...] }
    itemsPending = normalizeItems(data.items || data.pending || [], "pending");
  }
  async function loadPublic(){
    const data = await fetchJSON("/api/admin/list", { admin:true, signal: __ctrl.signal });
    itemsPublic = normalizeItems(data.items || data.list || data.public || [], "public");
  }
  async function loadAll(){
    // 期待：{ ok:true, items:[{...,scope:"pending/public"}] }
    const data = await fetchJSON("/api/admin/all?scope=both", { admin:true, signal: __ctrl.signal });
    const raw = data.items || data.all || [];
    // scopeが無い場合は両方混ざってても見えるように fallback
    itemsAll = normalizeItems(raw, "both").map(x => ({
      ...x,
      scope: x.scope && x.scope !== "both" ? x.scope : (x._scope || x.scope || "")
    }));

    // scope が付かない実装もあり得るので、id が pending/public に重複する場合は避ける
    // （必要なら worker 側で scope を付けるのが正）
  }

  async function refreshCurrentTab(){
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);

    try{
      if (activeTab === "pending") await loadPending();
      else if (activeTab === "public") await loadPublic();
      else await loadAll();
      updateSelectionUI();
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`更新に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function refreshAllTabs(){
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      await Promise.all([loadPending(), loadPublic(), loadAll()]);
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`更新に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  function getSelectedIds(){
    return Array.from(selectedIds);
  }

  async function approveIds(ids){
    if (!ids.length) return;
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      await fetchJSON("/api/admin/approve", { method:"POST", admin:true, body:{ ids }, signal: __ctrl.signal });
      // 更新
      await loadPending();
      await loadPublic();
      await loadAll();
      selectedIds = new Set();
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`承認に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function rejectIds(ids){
    if (!ids.length) return;
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      await fetchJSON("/api/admin/reject", { method:"POST", admin:true, body:{ ids }, signal: __ctrl.signal });
      await loadPending();
      await loadAll();
      selectedIds = new Set();
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`却下に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function deleteIds(ids){
    if (!ids.length) return;
    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);
    try{
      await fetchJSON("/api/admin/delete", { method:"POST", admin:true, body:{ ids }, signal: __ctrl.signal });
      await loadPublic();
      await loadAll();
      // pending から削除する実装の場合もあるので念のため
      await loadPending();
      selectedIds = new Set();
      render();
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`削除に失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  async function importSeed(){
    // ※ worker 側の実装名が違う可能性があるので、候補を順に試す（止まらない）
    const candidates = [
      "/api/admin/import-seed",
      "/api/admin/seed",
      "/api/admin/seed/import",
      "/api/admin/importSeed"
    ];

    abortInFlight();
    __ctrl = new AbortController();
    setBusy(true);

    let ok = false;
    let lastErr = null;

    try{
      for (const p of candidates){
        try{
          await fetchJSON(p, { method:"POST", admin:true, body:{}, signal: __ctrl.signal });
          ok = true;
          break;
        } catch(e){
          lastErr = e;
          // 404 は次候補へ
          if (e?.status === 404) continue;
          // 403 は即終了
          if (e?.status === 403) throw e;
          // その他も次へ（ただし abort などは止める）
          continue;
        }
      }

      if (!ok){
        const msg = lastErr ? lastErr.message : "不明";
        alert(`初期ネタ取り込みに失敗（エンドポイント未実装の可能性）: ${msg}`);
      } else {
        await refreshAllTabs();
        alert("初期ネタを取り込みました。");
      }
    } catch(e){
      if (e?.status === 403) setPill(pillAdmin, "admin: 403（鍵違い）", false);
      alert(`初期ネタ取り込みに失敗: ${e.message}`);
    } finally {
      setBusy(false);
      __ctrl = null;
    }
  }

  // ====== イベント ======
  btnSave.addEventListener("click", () => {
    saveSettings();
    alert("保存しました（このブラウザに記憶）");
  });

  btnHealth.addEventListener("click", doHealth);
  btnRefresh.addEventListener("click", refreshCurrentTab);
  btnRefreshAllTabs.addEventListener("click", refreshAllTabs);
  btnImportSeed.addEventListener("click", importSeed);

  tabPending.addEventListener("click", () => setActiveTab("pending"));
  tabPublic.addEventListener("click",  () => setActiveTab("public"));
  tabAll.addEventListener("click",     () => setActiveTab("all"));

  chkAll.addEventListener("change", () => {
    const items = getActiveItems();
    if (chkAll.checked){
      items.forEach(x => selectedIds.add(x.id));
    } else {
      // 現在タブの分だけ外す
      items.forEach(x => selectedIds.delete(x.id));
    }
    updateSelectionUI();
    // チェック反映
    listEl.querySelectorAll(".itemChk").forEach(chk => {
      const id = chk.getAttribute("data-id");
      chk.checked = selectedIds.has(id);
    });
  });

  btnBulkApprove.addEventListener("click", async () => {
    const ids = getSelectedIds();
    if (!ids.length) return alert("選択がありません");
    if (!confirm(`選択 ${ids.length}件 を承認しますか？`)) return;
    await approveIds(ids);
  });

  btnBulkReject.addEventListener("click", async () => {
    const ids = getSelectedIds();
    if (!ids.length) return alert("選択がありません");
    if (!confirm(`選択 ${ids.length}件 を却下しますか？`)) return;
    await rejectIds(ids);
  });

  btnBulkDelete.addEventListener("click", async () => {
    const ids = getSelectedIds();
    if (!ids.length) return alert("選択がありません");
    if (!confirm(`選択 ${ids.length}件 を削除しますか？（元に戻せません）`)) return;
    await deleteIds(ids);
  });

  // リスト内のクリック（委譲）
  listEl.addEventListener("click", async (ev) => {
    const t = ev.target;
    if (!(t instanceof HTMLElement)) return;

    // チェックボックス
    if (t.classList.contains("itemChk")){
      const id = t.getAttribute("data-id");
      if (!id) return;
      if (t.checked) selectedIds.add(id);
      else selectedIds.delete(id);
      updateSelectionUI();
      return;
    }

    const act = t.getAttribute("data-act");
    const id = t.getAttribute("data-id");
    if (!act || !id) return;

    if (act === "approve"){
      if (!confirm("この1件を承認しますか？")) return;
      await approveIds([id]);
    } else if (act === "reject"){
      if (!confirm("この1件を却下しますか？")) return;
      await rejectIds([id]);
    } else if (act === "delete"){
      if (!confirm("この1件を削除しますか？（元に戻せません）")) return;
      await deleteIds([id]);
    }
  });

  // Enterで保存/health しない（誤爆防止）
  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      const el = document.activeElement;
      if (el === elApiBase || el === elAdminKey){
        e.preventDefault();
        // ここでは何もしない（誤爆で通信→固まり防止）
      }
    }
  });

  // ====== 初期化 ======
  loadSettings();
  // 初回は軽く health を押せるようにする（自動通信はしない）
  setPill(pillHealth, "health: 未確認", null);
  setPill(pillAdmin,  "admin: 未確認", null);
  render();

})();
</script>

</body>
</html>
<!-- # END -->
